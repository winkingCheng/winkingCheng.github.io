<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ElasticSearch高级篇 | WinKings Blogs</title><meta name="keywords" content="ElasticSearch,NoSQL,搜索,原理"><meta name="author" content="WinKing"><meta name="copyright" content="WinKing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="ElasticSearch高级一、ElasticSearch集群的搭建1、为何要搭建 Elasticsearch 集群&amp;emsp;&amp;emsp;为什么我们需要搭建集群？它有什么优势呢？ 高可用性&amp;emsp;&amp;emsp;Elasticsearch 作为一个搜索引擎，我们对它的基本要求就是存储海量数据并且可以在非常短的时间内查询到我们想要的信息。所以第一步我们需要保证的就是 Elasticsearch">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch高级篇">
<meta property="og:url" content="http://cheng_qiwei.gitee.io/blog/2021/04/22/ElasticSearch%E9%AB%98%E7%BA%A7%E7%AF%87/index.html">
<meta property="og:site_name" content="WinKings Blogs">
<meta property="og:description" content="ElasticSearch高级一、ElasticSearch集群的搭建1、为何要搭建 Elasticsearch 集群&amp;emsp;&amp;emsp;为什么我们需要搭建集群？它有什么优势呢？ 高可用性&amp;emsp;&amp;emsp;Elasticsearch 作为一个搜索引擎，我们对它的基本要求就是存储海量数据并且可以在非常短的时间内查询到我们想要的信息。所以第一步我们需要保证的就是 Elasticsearch">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-04-22T14:00:00.000Z">
<meta property="article:modified_time" content="2021-04-22T14:00:00.000Z">
<meta property="article:author" content="WinKing">
<meta property="article:tag" content="ElasticSearch">
<meta property="article:tag" content="NoSQL">
<meta property="article:tag" content="搜索">
<meta property="article:tag" content="原理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/blog/img/favicon.png"><link rel="canonical" href="http://cheng_qiwei.gitee.io/blog/2021/04/22/ElasticSearch%E9%AB%98%E7%BA%A7%E7%AF%87/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/blog/WinKings%20Blogs" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-22 22:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/blog/img/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">25</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">48</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/blog/">WinKings Blogs</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch高级篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-22T14:00:00.000Z" title="发表于 2021-04-22 22:00:00">2021-04-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-22T14:00:00.000Z" title="更新于 2021-04-22 22:00:00">2021-04-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/ElasticSearch/">ElasticSearch</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ElasticSearch高级"><a href="#ElasticSearch高级" class="headerlink" title="ElasticSearch高级"></a>ElasticSearch高级</h1><h2 id="一、ElasticSearch集群的搭建"><a href="#一、ElasticSearch集群的搭建" class="headerlink" title="一、ElasticSearch集群的搭建"></a>一、ElasticSearch集群的搭建</h2><h3 id="1、为何要搭建-Elasticsearch-集群"><a href="#1、为何要搭建-Elasticsearch-集群" class="headerlink" title="1、为何要搭建 Elasticsearch 集群"></a>1、为何要搭建 Elasticsearch 集群</h3><p>&emsp;&emsp;为什么我们需要搭建集群？它有什么优势呢？</p>
<h4 id="高可用性"><a href="#高可用性" class="headerlink" title="高可用性"></a>高可用性</h4><p>&emsp;&emsp;Elasticsearch 作为一个搜索引擎，我们对它的基本要求就是存储海量数据并且可以在非常短的时间内查询到我们想要的信息。所以第一步我们需要保证的就是 Elasticsearch 的高可用性。</p>
<p>&emsp;&emsp;那么怎样提高 Elasticsearch 的高可用性呢？这时集群的作用就体现出来了。假如 Elasticsearch 只放在一台服务器上，即单机运行，假如这台主机突然断网了或者被攻击了，那么整个 Elasticsearch 的服务就不可用了。但如果改成 Elasticsearch 集群的话，有一台主机宕机了，还有其他的主机可以支撑，这样就仍然可以保证服务是可用的。</p>
<p>&emsp;&emsp;那么假如一台主机宕机了，那么不就无法访问这台主机的数据了吗？那假如我要访问的数据正好存在这台主机上，那不就获取不到了吗？难道其他的主机里面也存了一份一模一样的数据？那这岂不是很浪费吗？</p>
<p>&emsp;&emsp;在 Elasticsearch 中，一台主机宕机了，这台主机里面存的数据依然是可以被访问到的，因为在其他的主机上也有备份，但备份的时候也不是整台主机备份，是分片备份的，那这里就又引出了一个概念——分片。</p>
<p>&emsp;&emsp;分片，英文叫做 Shard，顾名思义，分片就是对数据切分成了多个部分。我们知道 Elasticsearch 中一个索引（Index）相当于是一个数据库，但索引存储的时候并不是整个存一起的，它是被分片存储的，Elasticsearch 默认会把一个索引分成五个分片，当然这个数字是可以自定义的。分片是数据的容器，数据保存在分片内，分片又被分配到集群内的各个节点里。当你的集群规模扩大或者缩小时， Elasticsearch 会自动的在各节点中迁移分片，使得数据仍然均匀分布在集群里，所以相当于一份数据被分成了多份并保存在不同的主机上。</p>
<p>&emsp;&emsp;那这还是没解决问题啊，如果一台主机挂掉了，那么这个分片里面的数据不就无法访问了？别的主机都是存储的其他的分片。其实是可以访问的，因为其他主机存储了这个分片的备份，叫做副本，这里就引出了另外一个概念——副本。</p>
<p>&emsp;&emsp;副本，英文叫做 Replica，同样顾名思义，副本就是对原分片的复制，和原分片的内容是一样的，Elasticsearch 默认会生成一份副本，所以相当于是五个原分片和五个分片副本，相当于一份数据存了两份，并分了十个分片，当然副本的数量也是可以自定义的。这时我们只需要将某个分片的副本存在另外一台主机上，这样当某台主机宕机了，我们依然还可以从另外一台主机的副本中找到对应的数据。所以从外部来看，数据结果是没有任何区别的。</p>
<p>&emsp;&emsp;一般来说，Elasticsearch 会尽量把一个索引的不同分片存储在不同的主机上，分片的副本也尽可能存在不同的主机上，这样可以提高容错率，从而提高可用性。</p>
<p>&emsp;&emsp;但这时假如你只有一台主机，那不就没办法了吗？分片和副本其实是没意义的，一台主机挂掉了，就全挂掉了。</p>
<h4 id="健康状态"><a href="#健康状态" class="headerlink" title="健康状态"></a>健康状态</h4><p>针对一个索引，Elasticsearch 中其实有专门的衡量索引健康状况的标志，分为三个等级：</p>
<ul>
<li>green（绿色）：这代表所有的主分片和副本分片都已分配，你的集群是 100% 可用的。</li>
<li>yellow（黄色）：所有的主分片已经分片了，但至少还有一个副本是缺失的。不会有数据丢失，所以搜索结果依然是完整的。不过，你的高可用性在某种程度上被弱化。如果更多的分片消失，你就会丢数据了。所以可把 yellow 想象成一个需要及时调查的警告。</li>
<li>red（红色）：至少一个主分片以及它的全部副本都在缺失中。这意味着你在缺少数据，搜索只能返回部分数据，而分配到这个分片上的写入请求会返回一个异常。</li>
</ul>
<p>&emsp;&emsp;如果你只有一台主机的话，其实索引的健康状况也是 yellow，因为一台主机，集群没有其他的主机可以防止副本，所以说，这就是一个不健康的状态，因此集群也是十分有必要的。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/image-20210415170843264.png" alt="image-20210415170843264"></p>
<h4 id="存储空间"><a href="#存储空间" class="headerlink" title="存储空间"></a>存储空间</h4><p>&emsp;&emsp;另外，既然是集群，那么存储空间肯定也是联合起来的，假如一台主机的存储空间是固定的，那么集群它相对于单个主机也有更多的存储空间，可存储的数据量也更大。</p>
<h3 id="2、Linux环境下搭建ElasticSearch集群"><a href="#2、Linux环境下搭建ElasticSearch集群" class="headerlink" title="2、Linux环境下搭建ElasticSearch集群"></a>2、Linux环境下搭建ElasticSearch集群</h3><h4 id="2-1、环境准备"><a href="#2-1、环境准备" class="headerlink" title="2.1、环境准备"></a>2.1、环境准备</h4><ul>
<li>安装包下载：见上一篇<a href="http://cheng_qiwei.gitee.io/blog/2021/04/14/ElasticSearch%E5%9F%BA%E7%A1%80%E7%AF%87/">文档</a></li>
</ul>
<h4 id="2-2、安装部署ElasticSearch"><a href="#2-2、安装部署ElasticSearch" class="headerlink" title="2.2、安装部署ElasticSearch"></a>2.2、安装部署ElasticSearch</h4><h5 id="2-2-1、解压安装包"><a href="#2-2-1、解压安装包" class="headerlink" title="2.2.1、解压安装包"></a>2.2.1、解压安装包</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf elasticsearch-7.12.0-linux-x86_64.tar.gz -C /usr/local/es/</span><br></pre></td></tr></table></figure>

<p>这里注意不要安装在<code>/root</code>目录下</p>
<h5 id="2-2-2、创建data目录和log目录"><a href="#2-2-2、创建data目录和log目录" class="headerlink" title="2.2.2、创建data目录和log目录"></a>2.2.2、创建data目录和log目录</h5><p>在elasticsearch-7.12.0的目录下创建data目录，用于保存数据。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/es/elasticsearch-7.12.0/ &amp;&amp; mkdir data</span><br></pre></td></tr></table></figure>

<h5 id="2-2-3、修改配置文件"><a href="#2-2-3、修改配置文件" class="headerlink" title="2.2.3、修改配置文件"></a>2.2.3、修改配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./config/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<p>修改结果如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================== Elasticsearch Configuration =========================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群名称</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">myelasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点名称</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示该节点会不会作为主节点，true表示会；false表示不会</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前节点是否用于存储数据，是：true、否：false</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据保存路径</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/usr/local/es/elasticsearch-node-1/data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志保存路径</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/usr/local/es/elasticsearch-node-1/logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Lock the memory on startup</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点ip地址</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">192.168</span><span class="number">.66</span><span class="number">.128</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set a custom port for HTTP:</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9300</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;192.168.66.128&quot;</span>,<span class="string">&quot;192.168.66.129&quot;</span>,<span class="string">&quot;192.168.66.130&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止脑裂</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断结点是否脱离时间配置</span></span><br><span class="line"><span class="attr">discovery.zen.fd.ping_timeout:</span> <span class="string">60s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断结点是否脱离次数配置</span></span><br><span class="line"><span class="attr">discovery.zen.fd.ping_retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># es7.x 之后新增的配置，初始化一个新的集群时需要此配置来选举master</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示开启跨域访问支持，此值默认为fals</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示跨域访问允许的域名地址，可使用正则表达式，“*”则表示允许所有域名访问</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-4、修改JVM参数"><a href="#2-2-4、修改JVM参数" class="headerlink" title="2.2.4、修改JVM参数"></a>2.2.4、修改JVM参数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi config/jvm.options</span><br><span class="line"></span><br><span class="line">-Xms4g  →  -Xms512m</span><br><span class="line">-Xmx4g  →  -Xmx512m</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将配置进行修改</span></span><br><span class="line">8-13:-XX:+UseConcMarkSweepGC</span><br><span class="line"><span class="meta">#</span><span class="bash"> 改为</span></span><br><span class="line">8-13:-XX:+UseG1GC</span><br></pre></td></tr></table></figure>

<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618584006615.png" alt="1618584006615"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618586292054.png" alt="1618586292054"></p>
<h5 id="2-2-5、创建普通用户"><a href="#2-2-5、创建普通用户" class="headerlink" title="2.2.5、创建普通用户"></a>2.2.5、创建普通用户</h5><p>&emsp;&emsp;由于es无法使用root用户启动，所以我们需要创建一个用户用于es的启动，这里要注意密码不要设置过于简单，会不通过。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建用户组   groupadd esgroup</span><br><span class="line">创建用户     useradd -g esgroup es</span><br><span class="line">设置权限     chown -R es:esgroup /usr/local/es/</span><br><span class="line">设置密码     passwd es</span><br><span class="line">cqw1314520</span><br></pre></td></tr></table></figure>

<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618584684323.png" alt="1618584684323"></p>
<h5 id="2-2-6、修改linux内核参数"><a href="#2-2-6、修改linux内核参数" class="headerlink" title="2.2.6、修改linux内核参数"></a>2.2.6、修改linux内核参数</h5><p>我们需要修改Linux文件的最大打开数，否则会启动报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf </span><br><span class="line"></span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nofile 65536</span><br><span class="line">* soft nproc  4096</span><br><span class="line">* hard nproc  4096</span><br><span class="line">----------------------------------------------------------------------------------</span><br><span class="line">echo &quot;vm.max_map_count=262144&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h5 id="2-2-7、修改完成后，复制文件夹，拷贝出新的两个节点并放置到其他两台虚拟机中"><a href="#2-2-7、修改完成后，复制文件夹，拷贝出新的两个节点并放置到其他两台虚拟机中" class="headerlink" title="2.2.7、修改完成后，复制文件夹，拷贝出新的两个节点并放置到其他两台虚拟机中"></a>2.2.7、修改完成后，复制文件夹，拷贝出新的两个节点并放置到其他两台虚拟机中</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 改名</span></span><br><span class="line">mv elasticsearch-7.12.0/ elasticsearch-node-1</span><br></pre></td></tr></table></figure>

<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618632686053.png" alt="1618632686053"></p>
<h5 id="2-2-8、修改子节点配置文件"><a href="#2-2-8、修改子节点配置文件" class="headerlink" title="2.2.8、修改子节点配置文件"></a>2.2.8、修改子节点配置文件</h5><p>&emsp;&emsp;根据截图进行修改对应内容，同时，由于改名，节点1也需要进行data和log目录路径修改。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================== Elasticsearch Configuration =========================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群名称</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">myelasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点名称</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示该节点会不会作为主节点，true表示会；false表示不会</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前节点是否用于存储数据，是：true、否：false</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据保存路径</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/usr/local/es/elasticsearch-node-2/data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志保存路径</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/usr/local/es/elasticsearch-node-2/logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Lock the memory on startup</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点ip地址</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">192.168</span><span class="number">.66</span><span class="number">.129</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set a custom port for HTTP:</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9300</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;192.168.66.128&quot;</span>,<span class="string">&quot;192.168.66.129&quot;</span>,<span class="string">&quot;192.168.66.130&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止脑裂</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断结点是否脱离时间配置</span></span><br><span class="line"><span class="attr">discovery.zen.fd.ping_timeout:</span> <span class="string">60s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断结点是否脱离次数配置</span></span><br><span class="line"><span class="attr">discovery.zen.fd.ping_retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># es7.x 之后新增的配置，初始化一个新的集群时需要此配置来选举master</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示开启跨域访问支持，此值默认为fals</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示跨域访问允许的域名地址，可使用正则表达式，“*”则表示允许所有域名访问</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618632788502.png" alt="1618632788502"></p>
<h4 id="2-3、启动ElasticSearch集群"><a href="#2-3、启动ElasticSearch集群" class="headerlink" title="2.3、启动ElasticSearch集群"></a>2.3、启动ElasticSearch集群</h4><p><font color='red'>这里需要注意，至少启动两个节点，如果只启动一个节点，则会出现访问失败、连接失败等问题…</font></p>
<p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 切换到es用户</span></span><br><span class="line">su es </span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动命令,这里 -d 代表后台启动</span></span><br><span class="line">bash ./bin/elasticsearch -d</span><br></pre></td></tr></table></figure>

<p>使用命令开启端口防火墙权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=9200/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=9300/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>7、查看结果：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618633146820.png" alt="1618633146820"></p>
<p>使用head工具观察：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618647178078.png" alt="1618647178078"></p>
<p>或者访问：<a target="_blank" rel="noopener" href="http://ip:9200/_cluster/health%E6%9F%A5%E7%9C%8B%E5%81%A5%E5%BA%B7%E6%83%85%E5%86%B5">http://IP:9200/_cluster/health查看健康情况</a></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618651033029.png" alt="1618651033029"></p>
<h2 id="二、Es原理相关知识点"><a href="#二、Es原理相关知识点" class="headerlink" title="二、Es原理相关知识点"></a>二、Es原理相关知识点</h2><h3 id="1、单节点集群"><a href="#1、单节点集群" class="headerlink" title="1、单节点集群"></a>1、单节点集群</h3><p>&emsp;&emsp;使用我们的单机版es，创建索引（最新版本中，集群版本不支持单节点启动）</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618654099201.png" alt="1618654099201"></p>
<h3 id="2、故障转移"><a href="#2、故障转移" class="headerlink" title="2、故障转移"></a>2、故障转移</h3><p>&emsp;&emsp;当集群中只有一个节点在运行时，意味着会有一个单点故障问题——没有冗余。 幸运的是，我们只需再启动一个节点即可防止数据丢失。当你在同一台机器上启动了第二个节点时，只要它和第一个节点有同样的 cluster.name 配置，它就会自动发现集群并加入到其中。但是在不同机器上启动节点的时候，为了加入到同一集群，你需要配置一个可连接到的单播主机列表。之所以配置为使用单播发现，以防止节点无意中加入集群。只有在同一台机器上运行的节点才会自动组成集群。</p>
<p>&emsp;&emsp;如果启动了第二个节点，我们的集群将会拥有两个节点的集群: 所有主分片和副本分片都已被分配。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618654360643.png" alt="1618654360643"></p>
<h3 id="3、水平扩容"><a href="#3、水平扩容" class="headerlink" title="3、水平扩容"></a>3、水平扩容</h3><p>&emsp;&emsp;当启动了第三个节点，我们的集群将会拥有三个节点的集群 : 为了分散负载而对分片进行重新分配。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618654670366.png" alt="1618654670366"></p>
<h3 id="Question1：在上面的基础上，如果我们想要扩容超过6-个节点怎么办呢？"><a href="#Question1：在上面的基础上，如果我们想要扩容超过6-个节点怎么办呢？" class="headerlink" title="Question1：在上面的基础上，如果我们想要扩容超过6 个节点怎么办呢？"></a>Question1：在上面的基础上，如果我们想要扩容超过6 个节点怎么办呢？</h3><p>&emsp;&emsp;主分片的数目在索引创建时就已经确定了下来。实际上，这个数目定义了这个索引能够存储 的最大数据量。（实际大小取决于你的数据、硬件和使用场景。） 但是，读操作搜索和返回数据 可以同时被主分片 或 副本分片所处理，所以当你拥有越多的副本分片时，也将拥有越高的吞吐量。在运行中的集群上是可以动态调整副本分片数目的，我们可以按需伸缩集群。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618668699205.png" alt="1618668699205"></p>
<p>&emsp;&emsp;当然，如果只是在相同节点数目的集群上增加更多的副本分片并不能提高性能，因为每个分片从节点上获得的资源会变少。 你需要增加更多的硬件资源来提升吞吐量。但是更多的副本分片数提高了数据冗余量：按照上面的节点配置，我们可以在失去2 个节点的情况下不丢失任何数据。</p>
<h3 id="4、应对故障"><a href="#4、应对故障" class="headerlink" title="4、应对故障"></a>4、应对故障</h3><p>&emsp;&emsp;此时，我们关闭的节点是一个主节点。而集群必须拥有一个主节点来保证正常工作，所以发生的第一件事情就是选举一个新的主节点： Node 2 。在我们关闭 Node 1 的同时也失去了主分片 1 和 2 ，并且在缺失主分片的时候索引也不能正常工作。 如果此时来检查集群的状况，我们看到的状态将会为red ：不是所有主分片都在正常工作。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618668953595.png" alt="1618668953595"></p>
<p>&emsp;&emsp;幸运的是，在其它节点上存在着这两个主分片的完整副本，所以新的主节点立即将这些分片在 Node 2 和 Node 3 上对应的副本分片提升为主分片， 此时集群的状态将会为yellow 。这个提升主分片的过程是瞬间发生的。</p>
<h3 id="Question2：为什么我们集群状态是yellow-而不是-green-呢？"><a href="#Question2：为什么我们集群状态是yellow-而不是-green-呢？" class="headerlink" title="Question2：为什么我们集群状态是yellow 而不是 green 呢？"></a>Question2：为什么我们集群状态是yellow 而不是 green 呢？</h3><p>&emsp;&emsp;虽然我们拥有所有的三个主分片，但是由于我们设置了每个主分片需要对应2 份副本分片，而此时只存在一份副本分片。 所以集群不能为 green 的状态，但是我们不必过于担心：如果我们同样关闭了 Node 2 ，我们的程序 依然 可以保持在不丢任何数据的情况下运行，因为Node 3 为每一个分片都保留着一份副本。如果我们重新启动Node 1 ，集群可以将缺失的副本分片再次进行分配，那么集群的 状态也将恢复成之前的状态。 如果 Node 1 依然拥有着之前的分片，它将尝试去重用它们，同时仅从主分片复制发生了修改的数据文件。和之前的集群相比，只是 Master 节点切换了。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618669319274.png" alt="1618669319274"></p>
<h3 id="5、路由计算"><a href="#5、路由计算" class="headerlink" title="5、路由计算"></a>5、路由计算</h3><p>&emsp;&emsp;当索引一个文档的时候，文档会被存储到一个主分片中。Elasticsearch 如何知道一个文档应该存放到哪个分片中呢？当我们创建文档时，它如何决定这个文档应当被存储在分片1 还是分片 2 中呢？首先这肯定不会是随机的，否则将来要获取文档的时候我们就不知道从何处寻找了。实际上，这个过程是根据下面这个公式决定的：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618669573377.png" alt="1618669573377"></p>
<p>公式解析：</p>
<p>&emsp;&emsp;routing是一个可变值，默认是文档的 _id ，也可以设置成一个自定义的值。 routing 通过hash 函数生成一个数字，然后这个数字再除以 number_of_primary_shards （主分片的数量后得到余数。这个分布在 0 到 number_of_primary_shards（分片数量）-1 之间的余数，就是我们所寻求的文档所在分片的位置。</p>
<p>&emsp;&emsp;所有的文档的API get 、 index 、 delete 、 bulk 、 update 以及 mget ）都接受一个叫做 routing 的路由参数 ，通过这个参数我们可以自定义文档到分片的映射。一个自定义的路由参数可以用来确保所有相关的文档 例如所有属于同一个用户的文档 都被存储到同一个分片中。</p>
<h3 id="6、分片控制"><a href="#6、分片控制" class="headerlink" title="6、分片控制"></a>6、分片控制</h3><p>&emsp;&emsp;我们可以发送请求到集群中的任一节点。每个节点都有能力处理任意请求。 每个节点都知道集群中任一文档位置，所以可以直接将请求转发到需要的节点上。 我们将这类转发的节点称为。**协调节点 (coordinating node)**。</p>
<p>接下来，我们通过写流程、读流程和更新流程来了解协调节点的作用：</p>
<h4 id="6-1、写流程"><a href="#6-1、写流程" class="headerlink" title="6.1、写流程"></a>6.1、写流程</h4><p><img src="http://cheng_qiwei.gitee.io/blog/img/1618673590979.png" alt="1618673590979"></p>
<blockquote>
<p>新建、索引和删除文档所需要的步骤顺序：</p>
<p>1、客户端向任意集群节点发送请求；</p>
<p>2、获得请求的节点成为协调节点，该节点使用文档的id计算该文档属于哪个主分片，将文档发送给计算出来结果的那个主分片所在的节点；</p>
<p>3、主分片负责将数据进行保存，并将数据发送给对应的副本进行同步；</p>
<p>4、副本保存完成后，向主分片进行反馈；</p>
<p>5、主分片向客户端进行反馈，客户端获取返回结果。</p>
</blockquote>
<p>&emsp;&emsp;在客户端收到成功响应时，文档变更已经在主分片和所有副本分片执行完成，变更是安全的。有一些可选的请求参数允许你影响这个过程，可能以数据安全为代价提升性能。这些选项很少使用，因为 Elasticsearch 已经很快，但是为了完整起见， 请参考下面内容：</p>
<p>参数： consistency </p>
<p>&emsp;&emsp;consistency，即一致性。在默认设置下，即使仅仅是在试图执行一个 写 操作之前，主分片都会要求 必须要有 规定数量 ( quorum)（或者换种说法，也即必须要有大多数）的分片副本处于活跃可用状态，才会去执行 写 操作 其中分片副本可以是主分片或者副本分片 。这是为了避免在发生网络分区故障（ networkpartition ）的时候进行 写 操作，进而导致数据不一致。 规定数量 即：                                                                                                                                   &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;int( (primary + number_of_replicas) / 2 ) + 1<br>&emsp;&emsp;consistency参数的值可以设为<font color='red'>one （只要主分片状态 ok 就允许执行 写 操作）,all （必须要主分片和所有副本分片的状态没问题才允许执行 写 操作） , 或quorum 。默认值为 quorum , 即大多数的分片副本状态没问题就允许执行 写操作。</font>注意，规定数量的计算公式中 number_of_replicas 指的是在索引设置中的设定副本分片数，而不是指当前处理活动状态的副本分片数。如果你的索引设置中指定了当前索引拥有三个副本分片，那规定数量的计算结果即：<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;int( (primary + 3 replicas) / 2 ) + 1 = 3<br>&emsp;&emsp;如果此时你只启动两个节点，那么处于活跃状态的分片副本数量就达不到规定数量，也因此您将无法索引和删除任何文档。<br>参数：timeout     </p>
<p>&emsp;&emsp;如果没有足够的副本分片会发生什么？Elasticsearch 会等待，希望更多的分片出现。默认情况下，它最多等待 1 分钟。 如果你需要，你可以使用 timeout 参数使它更早终止： 100 100 毫秒， 30s 是 30 秒。 </p>
<p>&emsp;&emsp;新索引默认有1 个副本分片，这意味着为满足规定数量应该需要两个活动的分片副本。 但是，这些默认的设置会阻止我们在单一节点上做任何事情。为了避免这个问题，要求只有当 number_of_replicas 大于 1 的时候，规定数量才会执行。</p>
<h4 id="6-2、读流程"><a href="#6-2、读流程" class="headerlink" title="6.2、读流程"></a>6.2、读流程</h4><p><img src="http://cheng_qiwei.gitee.io/blog/img/1618673574467.png" alt="1618673574467"></p>
<blockquote>
<p> 检索文档的步骤顺序：</p>
<p>1、客户端发送查询请求到任意节点；</p>
<p>2、获得请求的节点成为协调节点，该节点计算数据所在的分片及全部副本的位置；</p>
<p>3、为了能够负债均衡，可以轮询所有节点；</p>
<p>4、将请求发送给具体的节点进行查询；</p>
<p>5、节点返回查询结果，并将结果反馈给客户端。</p>
</blockquote>
<h4 id="6-3、更新流程"><a href="#6-3、更新流程" class="headerlink" title="6.3、更新流程"></a>6.3、更新流程</h4><p><img src="http://cheng_qiwei.gitee.io/blog/img/1618673859453.png" alt="1618673859453"></p>
<blockquote>
<p>1、客户端发送查询请求到任意节点；</p>
<p>2、获得请求的节点成为协调节点，该节点使用文档的id计算该文档属于哪个主分片，将需要修改的内容发送给计算出来结果的那个主分片所在的节点；</p>
<p>3、节点从主分片上检索文档，修改数据，并且尝试重新索引主分片的文档。 如果文档已经被另一个进程修改，它会重试本步骤 ，超过 retry_on_conflict 次后放弃。</p>
<p>4、如果 该节点成功地更新文档，它将新版本的文档并行转发到 其他的副本上覆盖，重新建立索引。一旦所有副本分片都返回成功， 该节点将向协调节点也返回成功，协调节点向客户端返回成功。</p>
</blockquote>
<p>注意：当主分片把更改转发到副本分片时，它不会转发更新请求。 相反，它会<strong>转发完整文档的新版本</strong>。请记住，这些更改将会异步转发到副本分片，并且不能保证它们以发送它们相同的顺序到达。 如果 Elasticsearch 仅转发更改请求，则可能以错误的顺序应用更改，导致得到损坏的文档。</p>
<h3 id="7、分片原理"><a href="#7、分片原理" class="headerlink" title="7、分片原理"></a>7、分片原理</h3><p>&emsp;&emsp;分片是 Elasticsearch <font color='red'>最小的工作单元</font>。传统的数据库每个字段存储单个值，但这对全文检索并不够。文本字段中的每个单词需要被搜索，对数据库意味着需要单个字段有索引多值的能力。最好的支持 是 一个字段多个值需求的数据结构是<font color='red'>倒排索引</font>。</p>
<h4 id="7-1、倒排索引"><a href="#7-1、倒排索引" class="headerlink" title="7.1、倒排索引"></a>7.1、倒排索引</h4><p>&emsp;&emsp;说起倒排索引，就不得不说一下与他对应的正向索引。</p>
<p>&emsp;&emsp;所谓的正向索引，就是搜索引擎会将待搜索的文件都对应一个文件ID ，搜索时将这个ID 和搜索关键字进行对应，形成 K V 对，然后对关键字进行统计计数。从广义来说，正向索引（doc values） 本质上是一个序列化的 列式存储 。列式存储 适用于聚合、排序、脚本等操作，所有的数字、地理坐标、日期、IP 和不分析（ not_analyzed ）字符类型都会默认开启。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618720994762.png" alt="1618720994762"></p>
<p>&emsp;&emsp;但是互联网上收录在搜索引擎中的文档的数目是个天文数字，这样的索引结构根本无法满足实时返回排名结果的要求。 而倒排索引的优势在于<strong>查找包含某个项的文档</strong>。所以，搜索引擎会将正向索引重新构建为倒排索引，即把文件ID 对应到关键词的映射转换为关键词到文件 ID 的映射，每个关键词都对应着一系列的文件，这些文件中都出现这个关键词。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618731007150.png" alt="1618731007150"></p>
<h4 id="7-2、文档搜索"><a href="#7-2、文档搜索" class="headerlink" title="7.2、文档搜索"></a>7.2、文档搜索</h4><p>&emsp;&emsp;早期的全文检索会为整个文档集合建立一个很大的倒排索引并将其写入到磁盘。一旦新的索引就绪，旧的就会被其替换，这样最近的变化便可以被检索到。倒排索引被写入磁盘后是不可改变的。</p>
<p>而这个不变性具有重要的价值：</p>
<blockquote>
<p>1、<strong>不需要锁</strong>。如果你从来不更新索引，你就不需要担心多进程同时修改数据的问题。</p>
<p>2、一旦索引被读入内核的文件系统缓存，便会留在那里，由于其不变性，只要文件系统缓存中还有足够的空间，那么大部分读请求会直接请求内存，而不会命中磁盘。这提供了很大的性能提升。</p>
<p>3、而对于其他缓存（像上面讲到的filter缓存），在索引的生命周期内始终有效。它们不需要在每次数据改变时被重建，因为数据不会变化。</p>
<p>4、写入单个大的倒排索引允许数据被压缩，减少磁盘 I/O 和需要被缓存到内存的索引的使用量。</p>
</blockquote>
<p>&emsp;&emsp;当然，一个不变的索引也有不好的地方。主要事实是它是不可改变的! 假如你需要让一个新的文档可被搜索，你需要重建整个索引。这要么对一个索引所能包含的数据量造成了很大的限制，要么对索引可被更新的频率造成了很大的限制。那么如何在保留不变性的基础上实现倒排索引的更新呢？</p>
<h4 id="7-3、动态更新索引"><a href="#7-3、动态更新索引" class="headerlink" title="7.3、动态更新索引"></a>7.3、动态更新索引</h4><p>&emsp;&emsp;实现倒排索引的更新，唯一的方式是<font color='red'>使用更多的索引</font>。通过增加新的补充索引来反映修改，而不是直接重写整个倒排索引。每一个倒排索引都会被轮流查询到 从最早的开始查询完后再对结果进行合并。这也是ElasticSearch基于Lucene所引入的<font color='red'>按段搜索</font>的概念。</p>
<p>&emsp;&emsp;当一个查询被触发，所有已知的段按顺序被查询。词项统计会对所有段的结果进行聚合，以保证每个词和每个文档的关联都被准确计算。 这种方式可以用相对较低的成本将新文档添加到索引。<br>&emsp;&emsp;段是不可改变的，所以既不能把文档从旧的段中移除，也不能修改旧的段来进行反映文档的更新。 取而代之的是，每个提交点会包含一个 .del 文件，文件中会列出这些被删除文档的段信息。</p>
<p><font color='red'>注意：</font></p>
<blockquote>
<p>&emsp;&emsp;当一个文档被 “删除” 时，它实际上只是在 .del 文件中被 标记 删除。一个被标记删除的文档仍然可以被查询匹配到，文档仍然可以被查询匹配到， 但它会在最终结果被返回前从结果集中移除。但它会在最终结果被返回前从结果集中移除。<br>&emsp;&emsp;文档更新也是类似的操作方式：当一个文档被更新时，旧版本文档被标记删除，文档的新版本被索引到一个新的段中。 可能两个版本的文档都会被一个查询匹配到，但被删除的那个旧版本文档在结果集返回前就已经被移除。</p>
</blockquote>
<h4 id="7-4、近实时搜索"><a href="#7-4、近实时搜索" class="headerlink" title="7.4、近实时搜索"></a>7.4、近实时搜索</h4><p>&emsp;&emsp;随着按段搜索的发展，一个新的文档从索引到可被 搜索的延迟显著降低了。新文档在几分钟之内即可被检索，但这样还是不够快。如图，一个新的文档从索引到可被搜索的延时为：</p>
<p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<strong>延时 = 主分片操作时的延时 + 并行写入副本的最大延时</strong></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618746041856.png" alt="1618746041856"></p>
<h5 id="7-4-1、写操作在内存与磁盘中的流程"><a href="#7-4-1、写操作在内存与磁盘中的流程" class="headerlink" title="7.4.1、写操作在内存与磁盘中的流程"></a>7.4.1、写操作在内存与磁盘中的流程</h5><p><img src="http://cheng_qiwei.gitee.io/blog/img/1618757764643.png" alt="1618757764643"></p>
<blockquote>
<p>1、一个文档被索引之后，就会被添加到内存缓冲区，然后追加到了 translog；</p>
<p>2、分片每秒会被刷新1次在（refresh：1s）；</p>
<p>把内存缓冲区中的文档写入文件系统缓存os cache中，同时使该缓存能够被搜索，同时清空内存缓冲区</p>
<p>3、每隔一段较长的时间文件系统缓存执行一次刷新（flush：30min，或者transLog太大时）</p>
<p>此时会将之前追加的日志创建成一个新的transLog，并将一个提交点写入磁盘，旧的translog被删除。</p>
<p>在flush到磁盘时，此时就会合并之前的操作，例如，之前修改一个文档是保存一份文档的新版本，同时对旧版本标记删除，合并时就真的会将旧版本进行删除，删除文档同理。</p>
</blockquote>
<h2 id="三、文档分析"><a href="#三、文档分析" class="headerlink" title="三、文档分析"></a>三、文档分析</h2><p>ElasticSearch对文档分析，其实包含下面的过程：<br>a、将一块文本分成适合于倒排索引的独立的 词条；<br>b、将这些词条统一化为标准格式以提高它们的 可搜索性 ，或者 recall。</p>
<h3 id="1、分析器的功能"><a href="#1、分析器的功能" class="headerlink" title="1、分析器的功能"></a>1、分析器的功能</h3><p>&emsp;&emsp;分析器执行分析的操作，其实是将字符过滤器、分词器和Token过滤器三个功能封装在一起。</p>
<h4 id="1-1、字符过滤器（character-filter）"><a href="#1-1、字符过滤器（character-filter）" class="headerlink" title="1.1、字符过滤器（character filter）"></a>1.1、字符过滤器（character filter）</h4><p>&emsp;&emsp;字符过滤器会在最早执行，它的功能主要是在分此前整理字符串。例如：去掉html标签，或者转换字符（&amp; –&gt;  and）等等。</p>
<blockquote>
<p>字符过滤器的类型一般有三种</p>
<p>a、<strong>html_scrip 自动去除html过滤器</strong>：把过滤内容中所有的html标签进行过滤；</p>
<p>&emsp;&emsp;它包含一个配置项：escaped_tags 功能是保留某些标签，例如保留<code>&lt;a&gt;&lt;/a&gt;</code>标签，则配置”escaped_tags”: [“a”]即可。</p>
<p>b、<strong>mapping 映射过滤器</strong>：把某些内容映射为其他内容；</p>
<p>&emsp;&emsp;例如：把<code>&amp;</code>转换为<code>and</code>，把<code>|</code>转为<code>or</code>。</p>
<p>c、<strong>Pattern 正则过滤器</strong>：可以通过正则表达式对文档内容进行替换。</p>
<p>&emsp;&emsp;例如：把文档中所有的<code>-</code>替换成<code>_</code>，他有一个配置项：replacement 功能是填写替换的内容。</p>
</blockquote>
<h4 id="1-2、分词器（tokenizer）"><a href="#1-2、分词器（tokenizer）" class="headerlink" title="1.2、分词器（tokenizer）"></a>1.2、分词器（tokenizer）</h4><p>&emsp;&emsp;紧接其后，字符串会来到分词器这里，将字符串分成单个的词条。一个简单的分词器遇到空格或标点符号的时候，可能会将文本拆分成词条。</p>
<h4 id="1-3、Token过滤器（token-filter）"><a href="#1-3、Token过滤器（token-filter）" class="headerlink" title="1.3、Token过滤器（token filter）"></a>1.3、Token过滤器（token filter）</h4><p>&emsp;&emsp;最后词条按照顺序通过每个Token过滤器，在这个过程中，可能会对词条进行改变，例如：删除一些没意义的词条（a 、the 、and），或者改变词条（将Quick –&gt; quick），或者增加词条（类似jump和leap这种同义词）等等。</p>
<h3 id="2、ElasticSearch的内置分析器"><a href="#2、ElasticSearch的内置分析器" class="headerlink" title="2、ElasticSearch的内置分析器"></a>2、ElasticSearch的内置分析器</h3><p>&emsp;&emsp;Elasticsearch附带了可以直接使用的预包装的分析器。接下来我们简单介绍几种：</p>
<h4 id="2-1、简单分析器"><a href="#2-1、简单分析器" class="headerlink" title="2.1、简单分析器"></a>2.1、简单分析器</h4><p>&emsp;&emsp;简单分析器会在任何不是字母的地方分割文本并将词条小写。如：</p>
<p>set,a.file_index  ===&gt;   set,a,file,index</p>
<h4 id="2-2、空格分析器"><a href="#2-2、空格分析器" class="headerlink" title="2.2、空格分析器"></a>2.2、空格分析器</h4><p>&emsp;&emsp;空格分析器会在任何空格的地方划分文本。如：</p>
<p>set   a  file_index ===&gt;  set,a,file_index</p>
<h4 id="2-3、语言分析器"><a href="#2-3、语言分析器" class="headerlink" title="2.3、语言分析器"></a>2.3、语言分析器</h4><p>&emsp;&emsp;特定的语言分析器可以对不同语言进行分析，由于可以考虑语言的特点，它们分析的结果往往更加符合实际情况。例如：英语分析器自带一组英语无用词库，可以将一些没有意义的词汇进行删除（the 、a），亦或者可以提取英语单词的词干（logs  ==&gt;  log），亦或者我们之前提到的IK分词器，能够对中文进行合理的分割。</p>
<h3 id="3、测试分析器"><a href="#3、测试分析器" class="headerlink" title="3、测试分析器"></a>3、测试分析器</h3><p>测试命令：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>,<span class="comment">//标准分析器</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;Text to analyze&quot;</span><span class="comment">//分析内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618841410863.png" alt="1618841410863"></p>
<p>名词解释：</p>
<p>token：指实际存储到索引的词条；</p>
<p>position：指词条在原始文本中出现的位置；</p>
<p>start_offset  和  end_offset：指字符在原始字符串中的位置。</p>
<h3 id="4、自定义分析器"><a href="#4、自定义分析器" class="headerlink" title="4、自定义分析器"></a>4、自定义分析器</h3><p>&emsp;&emsp;虽然Elasticsearch 带有一些现成的分析器，然而在分析器上 Elasticsearch 真正的强大之处在于，你可以通过在一个适合你的特定数据的设置之中组合字符过滤器、分词器、词汇单元过滤器来创建自定义的分析器。</p>
<p>自定义一个分析器：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;char_filter&quot;</span>: &#123;  <span class="comment">//自定义字符过滤器，设置映射规则</span></span><br><span class="line">          <span class="attr">&quot;&amp;_to_and&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;mapping&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;mappings&quot;</span>: [ <span class="string">&quot;&amp;=&gt; and &quot;</span>]</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>:&#123;  <span class="comment">//过滤器，过滤指定字符</span></span><br><span class="line">        <span class="attr">&quot;my_stopwords&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;stop&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;stopwords&quot;</span>: [ <span class="string">&quot;the&quot;</span>, <span class="string">&quot;a&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span>: &#123;   <span class="comment">//自定义分词器</span></span><br><span class="line">        <span class="attr">&quot;my_analyzer&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;custom&quot;</span>,  <span class="comment">//告诉ES这是一个自定义分词器</span></span><br><span class="line">          <span class="attr">&quot;char_filter&quot;</span>: [ <span class="string">&quot;html_strip&quot;</span>, <span class="string">&quot;&amp;_to_and&quot;</span> ],  <span class="comment">//设置两个字符过滤器</span></span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;standard&quot;</span>,  <span class="comment">//设置内置分词器作为基本分词器</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span>: [ <span class="string">&quot;lowercase&quot;</span>, <span class="string">&quot;my_stopwords&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分词测试：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618846054509.png" alt="1618846054509"></p>
<h2 id="四、文档冲突"><a href="#四、文档冲突" class="headerlink" title="四、文档冲突"></a>四、文档冲突</h2><p>&emsp;&emsp;Elasticsearch是分布式的。当文档创建、更新或删除时， 新版本的文档必须复制到集群中的其他节点。 Elasticsearch 也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许顺序是乱的 。 所以Elasticsearch 需要一种方法确保文档的旧版本不会覆盖新的版本。</p>
<p>&emsp;&emsp;我们之前在做各种各样的操作的时候，我们都知道每个文档中都存在一个版本号，当文件被修改时，版本号就会递增。ElasticSearch使用<font color='red'>CAS加版本号</font>来确保变更是被顺序执行的。如果版本不是当前版本号，我们的请求就会失败。</p>
<p>&emsp;&emsp;当然，旧的版本使用的是version，但是新的版本不建议了，会提示以下错误，提示我们使用 if_seq_no和 if_primary_term。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1618847618574.png" alt="1618847618574"></p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1hh411D7sb?p=1">https://www.bilibili.com/video/BV1hh411D7sb?p=1</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">WinKing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://cheng_qiwei.gitee.io/blog/2021/04/22/ElasticSearch%E9%AB%98%E7%BA%A7%E7%AF%87/">http://cheng_qiwei.gitee.io/blog/2021/04/22/ElasticSearch%E9%AB%98%E7%BA%A7%E7%AF%87/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cheng_qiwei.gitee.io/blog" target="_blank">WinKings Blogs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/ElasticSearch/">ElasticSearch</a><a class="post-meta__tags" href="/blog/tags/NoSQL/">NoSQL</a><a class="post-meta__tags" href="/blog/tags/%E6%90%9C%E7%B4%A2/">搜索</a><a class="post-meta__tags" href="/blog/tags/%E5%8E%9F%E7%90%86/">原理</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=null" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/2021/04/23/ELasticSearch%E9%9D%A2%E8%AF%95%E9%A2%98/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ElasticSearch面试题</div></div></a></div><div class="next-post pull-right"><a href="/blog/2021/04/14/ElasticSearch%E5%9F%BA%E7%A1%80%E7%AF%87/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ElasticSearch基础篇</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/blog/2021/04/14/ElasticSearch基础篇/" title="ElasticSearch基础篇"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-14</div><div class="title">ElasticSearch基础篇</div></div></a></div><div><a href="/blog/2021/04/23/ELasticSearch面试题/" title="ElasticSearch面试题"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-23</div><div class="title">ElasticSearch面试题</div></div></a></div><div><a href="/blog/2021/07/25/zookeeper介绍/" title="zookeeper详解"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-25</div><div class="title">zookeeper详解</div></div></a></div><div><a href="/blog/2021/05/10/MySQL原理与优化/" title="MySQL原理与优化"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">MySQL原理与优化</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/blog/img/touxiang.jpg" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">WinKing</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">25</div></a></div><div class="card-info-data-item is-center"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">48</div></a></div><div class="card-info-data-item is-center"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/cheng_qiwei"><i class="fab fa-gitee"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ElasticSearch%E9%AB%98%E7%BA%A7"><span class="toc-text">ElasticSearch高级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81ElasticSearch%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-text">一、ElasticSearch集群的搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%B8%BA%E4%BD%95%E8%A6%81%E6%90%AD%E5%BB%BA-Elasticsearch-%E9%9B%86%E7%BE%A4"><span class="toc-text">1、为何要搭建 Elasticsearch 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-text">高可用性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="toc-text">健康状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4"><span class="toc-text">存储空间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%90%AD%E5%BB%BAElasticSearch%E9%9B%86%E7%BE%A4"><span class="toc-text">2、Linux环境下搭建ElasticSearch集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">2.1、环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ElasticSearch"><span class="toc-text">2.2、安装部署ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1%E3%80%81%E8%A7%A3%E5%8E%8B%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-text">2.2.1、解压安装包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2%E3%80%81%E5%88%9B%E5%BB%BAdata%E7%9B%AE%E5%BD%95%E5%92%8Clog%E7%9B%AE%E5%BD%95"><span class="toc-text">2.2.2、创建data目录和log目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3%E3%80%81%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2.2.3、修改配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4%E3%80%81%E4%BF%AE%E6%94%B9JVM%E5%8F%82%E6%95%B0"><span class="toc-text">2.2.4、修改JVM参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5%E3%80%81%E5%88%9B%E5%BB%BA%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7"><span class="toc-text">2.2.5、创建普通用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-6%E3%80%81%E4%BF%AE%E6%94%B9linux%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="toc-text">2.2.6、修改linux内核参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-7%E3%80%81%E4%BF%AE%E6%94%B9%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E6%8B%B7%E8%B4%9D%E5%87%BA%E6%96%B0%E7%9A%84%E4%B8%A4%E4%B8%AA%E8%8A%82%E7%82%B9%E5%B9%B6%E6%94%BE%E7%BD%AE%E5%88%B0%E5%85%B6%E4%BB%96%E4%B8%A4%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD"><span class="toc-text">2.2.7、修改完成后，复制文件夹，拷贝出新的两个节点并放置到其他两台虚拟机中</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-8%E3%80%81%E4%BF%AE%E6%94%B9%E5%AD%90%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2.2.8、修改子节点配置文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81%E5%90%AF%E5%8A%A8ElasticSearch%E9%9B%86%E7%BE%A4"><span class="toc-text">2.3、启动ElasticSearch集群</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Es%E5%8E%9F%E7%90%86%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-text">二、Es原理相关知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%8D%95%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4"><span class="toc-text">1、单节点集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">2、故障转移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9"><span class="toc-text">3、水平扩容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Question1%EF%BC%9A%E5%9C%A8%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8A%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E6%83%B3%E8%A6%81%E6%89%A9%E5%AE%B9%E8%B6%85%E8%BF%876-%E4%B8%AA%E8%8A%82%E7%82%B9%E6%80%8E%E4%B9%88%E5%8A%9E%E5%91%A2%EF%BC%9F"><span class="toc-text">Question1：在上面的基础上，如果我们想要扩容超过6 个节点怎么办呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%BA%94%E5%AF%B9%E6%95%85%E9%9A%9C"><span class="toc-text">4、应对故障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Question2%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E6%98%AFyellow-%E8%80%8C%E4%B8%8D%E6%98%AF-green-%E5%91%A2%EF%BC%9F"><span class="toc-text">Question2：为什么我们集群状态是yellow 而不是 green 呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97"><span class="toc-text">5、路由计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E5%88%86%E7%89%87%E6%8E%A7%E5%88%B6"><span class="toc-text">6、分片控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1%E3%80%81%E5%86%99%E6%B5%81%E7%A8%8B"><span class="toc-text">6.1、写流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2%E3%80%81%E8%AF%BB%E6%B5%81%E7%A8%8B"><span class="toc-text">6.2、读流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3%E3%80%81%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="toc-text">6.3、更新流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E5%88%86%E7%89%87%E5%8E%9F%E7%90%86"><span class="toc-text">7、分片原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1%E3%80%81%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">7.1、倒排索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2%E3%80%81%E6%96%87%E6%A1%A3%E6%90%9C%E7%B4%A2"><span class="toc-text">7.2、文档搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3%E3%80%81%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95"><span class="toc-text">7.3、动态更新索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4%E3%80%81%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2"><span class="toc-text">7.4、近实时搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-4-1%E3%80%81%E5%86%99%E6%93%8D%E4%BD%9C%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%8E%E7%A3%81%E7%9B%98%E4%B8%AD%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-text">7.4.1、写操作在内存与磁盘中的流程</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%96%87%E6%A1%A3%E5%88%86%E6%9E%90"><span class="toc-text">三、文档分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%86%E6%9E%90%E5%99%A8%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-text">1、分析器的功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E3%80%81%E5%AD%97%E7%AC%A6%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%88character-filter%EF%BC%89"><span class="toc-text">1.1、字符过滤器（character filter）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2%E3%80%81%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88tokenizer%EF%BC%89"><span class="toc-text">1.2、分词器（tokenizer）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3%E3%80%81Token%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%88token-filter%EF%BC%89"><span class="toc-text">1.3、Token过滤器（token filter）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81ElasticSearch%E7%9A%84%E5%86%85%E7%BD%AE%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">2、ElasticSearch的内置分析器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">2.1、简单分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E7%A9%BA%E6%A0%BC%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">2.2、空格分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81%E8%AF%AD%E8%A8%80%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">2.3、语言分析器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%B5%8B%E8%AF%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">3、测试分析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">4、自定义分析器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%96%87%E6%A1%A3%E5%86%B2%E7%AA%81"><span class="toc-text">四、文档冲突</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/" title="zookeeper详解"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="zookeeper详解"/></a><div class="content"><a class="title" href="/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/" title="zookeeper详解">zookeeper详解</a><time datetime="2021-07-25T14:00:00.000Z" title="发表于 2021-07-25 22:00:00">2021-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/07/10/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E5%88%86%E5%8C%BA%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94Hash%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7Hash/" title="分布式缓存分区算法——Hash与一致性Hash"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="分布式缓存分区算法——Hash与一致性Hash"/></a><div class="content"><a class="title" href="/blog/2021/07/10/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E5%88%86%E5%8C%BA%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94Hash%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7Hash/" title="分布式缓存分区算法——Hash与一致性Hash">分布式缓存分区算法——Hash与一致性Hash</a><time datetime="2021-07-10T14:00:00.000Z" title="发表于 2021-07-10 22:00:00">2021-07-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/30/Redis%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%8C%BA/" title="Redis集群与分区"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis集群与分区"/></a><div class="content"><a class="title" href="/blog/2021/06/30/Redis%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%8C%BA/" title="Redis集群与分区">Redis集群与分区</a><time datetime="2021-06-30T14:00:00.000Z" title="发表于 2021-06-30 22:00:00">2021-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/14/Redis%E7%9A%84%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" title="Redis的进阶使用"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis的进阶使用"/></a><div class="content"><a class="title" href="/blog/2021/06/14/Redis%E7%9A%84%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" title="Redis的进阶使用">Redis的进阶使用</a><time datetime="2021-06-14T14:00:00.000Z" title="发表于 2021-06-14 22:00:00">2021-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/07/Redis%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%91%BD%E4%BB%A4/" title="Redis介绍与命令"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis介绍与命令"/></a><div class="content"><a class="title" href="/blog/2021/06/07/Redis%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%91%BD%E4%BB%A4/" title="Redis介绍与命令">Redis介绍与命令</a><time datetime="2021-06-07T14:00:00.000Z" title="发表于 2021-06-07 22:00:00">2021-06-07</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By WinKing</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="/blog/js/tw_cn.js"></script><script src="/blog/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script></div></body></html>