<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>分布式事务和Alibaba Seata的介绍和使用 | WinKings Blogs</title><meta name="keywords" content="分布式事务,Seata"><meta name="author" content="WinKing"><meta name="copyright" content="WinKing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="分布式事务和Alibaba  Seata的介绍和使用分布式事务什么是分布式事务？&amp;emsp;&amp;emsp;在一次大的操作由不同的小的操作组成的，这些小的操作分布在不同的服务器上，分布式需要保证这些小操作要么全部成功，要么全部失败。本质上讲，分布式事务就是为了保证不同数据库的数据一致性。 分布式事务产生的原因？原因一：数据库的分库分表&amp;emsp;&amp;emsp;当数据库单表数据超过千万级别，就需要考虑分库">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式事务和Alibaba Seata的介绍和使用">
<meta property="og:url" content="http://cheng_qiwei.gitee.io/blog/2021/03/15/Seata%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="WinKings Blogs">
<meta property="og:description" content="分布式事务和Alibaba  Seata的介绍和使用分布式事务什么是分布式事务？&amp;emsp;&amp;emsp;在一次大的操作由不同的小的操作组成的，这些小的操作分布在不同的服务器上，分布式需要保证这些小操作要么全部成功，要么全部失败。本质上讲，分布式事务就是为了保证不同数据库的数据一致性。 分布式事务产生的原因？原因一：数据库的分库分表&amp;emsp;&amp;emsp;当数据库单表数据超过千万级别，就需要考虑分库">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-03-15T14:00:00.000Z">
<meta property="article:modified_time" content="2021-04-10T09:06:09.477Z">
<meta property="article:author" content="WinKing">
<meta property="article:tag" content="分布式事务">
<meta property="article:tag" content="Seata">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/blog/img/favicon.png"><link rel="canonical" href="http://cheng_qiwei.gitee.io/blog/2021/03/15/Seata%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/blog/WinKings%20Blogs" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-10 17:06:09'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/blog/img/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">25</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">48</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/blog/">WinKings Blogs</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">分布式事务和Alibaba Seata的介绍和使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-03-15T14:00:00.000Z" title="发表于 2021-03-15 22:00:00">2021-03-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-10T09:06:09.477Z" title="更新于 2021-04-10 17:06:09">2021-04-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/SpringCloudAlibaba/">SpringCloudAlibaba</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/SpringCloudAlibaba/Seata/">Seata</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/SpringCloudAlibaba/Seata/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">分布式事务</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="分布式事务和Alibaba-Seata的介绍和使用"><a href="#分布式事务和Alibaba-Seata的介绍和使用" class="headerlink" title="分布式事务和Alibaba  Seata的介绍和使用"></a>分布式事务和Alibaba  Seata的介绍和使用</h1><h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><h2 id="什么是分布式事务？"><a href="#什么是分布式事务？" class="headerlink" title="什么是分布式事务？"></a>什么是分布式事务？</h2><p>&emsp;&emsp;在一次大的操作由不同的小的操作组成的，这些小的操作分布在不同的服务器上，分布式需要保证这些小操作要么全部成功，要么全部失败。本质上讲，分布式事务就是为了保证不同数据库的数据一致性。</p>
<h2 id="分布式事务产生的原因？"><a href="#分布式事务产生的原因？" class="headerlink" title="分布式事务产生的原因？"></a>分布式事务产生的原因？</h2><h3 id="原因一：数据库的分库分表"><a href="#原因一：数据库的分库分表" class="headerlink" title="原因一：数据库的分库分表"></a>原因一：数据库的分库分表</h3><p>&emsp;&emsp;当数据库单表数据超过千万级别，就需要考虑分库分表的问题，那么我们的系统就会从原来的一个数据库变成多个数据库，那么此时我们在同时操作多个数据库时，就需要保证数据的一致性，所以就需要使用分布式事务。</p>
<h3 id="原因二：应用SOA化"><a href="#原因二：应用SOA化" class="headerlink" title="原因二：应用SOA化"></a>原因二：应用SOA化</h3><p>&emsp;&emsp;所谓SOA化，就是业务的服务化。我们一个系统在访问量上去之后，我们会考虑把不同的功能放到不同的服务上面去运行，此时如果我们需要操作一连串功能，那么我们可能需要操作不同的服务，不同的数据库，为了保证数据的一致性，我们就需要使用分布式事务。</p>
<p>&emsp;&emsp;总结：不管是上面的那种方式，归根结底就是需要操作不同的数据库，为了保证数据的一致性，从而产生分布式事务。</p>
<h1 id="分布式理论"><a href="#分布式理论" class="headerlink" title="分布式理论"></a>分布式理论</h1><h2 id="CAP定理"><a href="#CAP定理" class="headerlink" title="CAP定理"></a>CAP定理</h2><p>&emsp;&emsp;CAP定理是由加州大学伯克利分校Eric Brewer教授提出来的，他指出WEB服务无法同时满足一下3个属性：</p>
<ul>
<li><p>一致性(Consistency) ： 客户端知道一系列的操作都会同时发生(生效)；</p>
</li>
<li><p>可用性(Availability) ： 每个操作都必须以可预期的响应结束；</p>
</li>
<li><p>分区容错性(Partition tolerance) ： 即使出现单个组件无法可用,操作依然可以完成。</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071607.jpg" alt="img"></p>
</li>
</ul>
<h3 id="CAP属性解读"><a href="#CAP属性解读" class="headerlink" title="CAP属性解读"></a>CAP属性解读</h3><p>&emsp;&emsp;<strong>a、分区容错性</strong>：指的分布式系统中的某个节点或者网络分区出现了故障的时候，整个系统仍然能对外提供满足一致性和可用性的服务。也就是说部分故障不影响整体使用。</p>
<p>事实上我们在设计分布式系统是都会考虑到bug，硬件，网络等各种原因造成的故障，所以即使部分节点或者网络出现故障，我们要求整个系统还是要继续使用的。</p>
<p>(不继续使用,相当于只有一个分区,那么也就没有后续的一致性和可用性了)</p>
<p>&emsp;&emsp;<strong>b、可用性：</strong> 一直可以正常的做读写操作。简单而言就是客户端一直可以正常访问并得到系统的正常响应。用户角度来看就是不会出现系统操作失败或者访问超时等问题。</p>
<p>&emsp;&emsp;<strong>c、一致性</strong>：在分布式系统完成某写操作后任何读操作，都应该获取到该写操作写入的那个最新的值。相当于要求分布式系统中的各节点时时刻刻保持数据的一致性。</p>
<h3 id="一致性与可用性的矛盾"><a href="#一致性与可用性的矛盾" class="headerlink" title="一致性与可用性的矛盾"></a>一致性与可用性的矛盾</h3><p>&emsp;&emsp;一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。</p>
<p>&emsp;&emsp;我们举个例子，以下图为例：</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071601.png" alt="img"></p>
<p>&emsp;&emsp;client修改G1中V0的数据为V1，按照正常情况下，修改之后，G1通知G2，V0修改为V1了，然后G2也同步修改为V1，name此时client读取G1或G2的数据都是V1；</p>
<p>&emsp;&emsp;但是，如果此时G1与G2之间的网络通信出现延迟或异常，那么G1中V0的数据为V1，但是G2还不知道，所以此时G2的数据还是V0</p>
<p>&emsp;&emsp;如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性。</p>
<p>&emsp;&emsp;如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。</p>
<p>&emsp;&emsp;综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。这也是我们一直只看到只有AP或CP的选择，没有选择CA的操作，而且放弃分区容错性，也意味着放弃系统的扩展性，系统不再是分布式的，有违设计的初衷。</p>
<h3 id="CAP特性的取舍策略"><a href="#CAP特性的取舍策略" class="headerlink" title="CAP特性的取舍策略"></a>CAP特性的取舍策略</h3><p>&emsp;&emsp;a、满足AP舍弃C，也就是满足可用性和容错性，舍弃一致性。这也就是意味着你的系统在并发访问的时候可能会出现数据不一致的情况。事实证明，大多数都是牺牲了一致性。像12306还有淘宝网，就好比是你买火车票，本来你看到的是还有一张票，其实在这个时刻已经被买走了，你填好了信息准备买的时候发现系统提示你没票了，这就是牺牲了一致性。</p>
<p>&emsp;&emsp;b、满足CP舍弃A，也就是满足一致性和容错性，舍弃可用性。如果你的系统允许有段时间的访问失效等问题，这个是可以满足的（确实来讲用户体验会很差）。</p>
<h2 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h2><p>&emsp;&emsp;在上面CAP的介绍中，我们说CAP三者不能同时满足，而分区容错对于分布式系统来讲，是必须的，所以出现BASE理论。BASE理论如图相当于CAP中的AP。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/9825bc315c6034a8b7e1a56f6737965008237682.jpeg" alt="9825bc315c6034a8b7e1a56f6737965008237682"></p>
<h3 id="什么是BASE理论"><a href="#什么是BASE理论" class="headerlink" title="什么是BASE理论"></a>什么是BASE理论</h3><p>&emsp;&emsp;BASE理论是 Basically Available(基本可用)，Soft state（软状态）和 Eventually consistent（最终一致性）三个短语的缩写，来自 ebay 的架构师提出。他的核心思想是：即使无法做到强一致性（Strong Consistency，CAP 的一致性就是强一致性），但应用可以采用适合的方式达到<strong>最终一致性</strong>（Eventual Consitency）。</p>
<h4 id="基本可用性（Basically-Available）"><a href="#基本可用性（Basically-Available）" class="headerlink" title="基本可用性（Basically Available）"></a>基本可用性（Basically Available）</h4><p>&emsp;&emsp;基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性<font color='red'>（但请注意，这绝不等价于系统不可用，以下两个就是“基本可用”的典型例子）</font>。</p>
<ul>
<li>响应时间上的损失：正常情况下，一个在线搜索引擎需要0.5秒内返回给用户相应的查询结果，但由于出现异常（比如系统部分机房发生断电或断网故障），查询结果的响应时间增加到了1~2秒。</li>
<li>功能上的损失：正常情况下，在一个电子商务网站上进行购物，消费者几乎能够顺利地完成每一笔订单，但是在一些节日大促购物高峰的时候，由于消费者的购物行为激增，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面。</li>
</ul>
<h4 id="软状态（Soft-state）"><a href="#软状态（Soft-state）" class="headerlink" title="软状态（Soft state）"></a>软状态（Soft state）</h4><p>&emsp;&emsp;软状态也称为弱状态，和硬状态相对，是指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步过程存在延时。</p>
<h4 id="最终一致性（Eventual-Consitency）"><a href="#最终一致性（Eventual-Consitency）" class="headerlink" title="最终一致性（Eventual Consitency）"></a>最终一致性（Eventual Consitency）</h4><p>&emsp;&emsp;最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。</p>
<p>而在实际工程实践中，<strong>最终一致性分为 5 种：</strong></p>
<p><strong>a、因果一致性（Causal consistency）</strong></p>
<p>&emsp;&emsp;如果节点 A 在更新完某个数据后通知了节点 B，那么节点 B 之后对该数据的访问和修改都是基于 A 更新后的值。与此同时，和节点 A 无因果关系的节点 C 的数据访问则没有这样的限制。</p>
<p><strong>b、 读己之所写（Read your writes）</strong></p>
<p>&emsp;&emsp;这种就很简单了，节点 A 更新一个数据后，它自身总是能访问到自身更新过的最新值，而不会看到旧值。其实也算一种因果一致性。</p>
<p><strong>c、会话一致性（Session consistency）</strong></p>
<p>&emsp;&emsp;会话一致性将对系统数据的访问过程框定在了一个会话当中：系统能保证在同一个有效的会话中实现 “读己之所写” 的一致性，也就是说，执行更新操作之后，客户端能够在同一个会话中始终读取到该数据项的最新值。</p>
<p><strong>d、 单调读一致性（Monotonic read consistency）</strong></p>
<p>&emsp;&emsp;单调读一致性是指如果一个节点从系统中读取出一个数据项的某个值后，那么系统对于该节点后续的任何数据访问都不应该返回更旧的值。</p>
<p><strong>e、单调写一致性（Monotonic write consistency）</strong></p>
<p>&emsp;&emsp;指一个系统要能够保证来自同一个节点的写操作被顺序的执行。</p>
<p>&emsp;&emsp;然而，在实际的实践中，这 5 种系统往往会结合使用，以构建一个具有最终一致性的分布式系统。实际上，不只是分布式系统使用最终一致性，关系型数据库在某个功能上，也是使用最终一致性的，比如备份，数据库的复制过程是需要时间的，这个复制过程中，业务读取到的值就是旧的。当然，最终还是达成了数据一致性。这也算是一个最终一致性的经典案例。</p>
<p>&emsp;&emsp;总的来说，BASE 理论面向的是大型高可用可扩展的分布式系统，和传统事务的 ACID 是<strong>相反的</strong>，它完全不同于 ACID 的强一致性模型，而是<strong>通过牺牲强一致性</strong>来获得可用性，并允许数据在一段时间是不一致的。</p>
<h1 id="分布式事务的解决方案"><a href="#分布式事务的解决方案" class="headerlink" title="分布式事务的解决方案"></a>分布式事务的解决方案</h1><p><font size='5px'><strong>刚性事务</strong></font></p>
<h2 id="2PC（-XA-Transactions）"><a href="#2PC（-XA-Transactions）" class="headerlink" title="2PC（ XA Transactions）"></a>2PC（ XA Transactions）</h2><p>&emsp;&emsp;XA，是一个两阶段的提交协议，定义了事务管理器（Transaction Manager）和资源管理器（Resource Manager）之间的接口。通过引入协调者（Coordinator）来协调参与者的行为，并最终决定这些参与者是否要真正执行事务，该协议分为以下两个阶段：</p>
<p>a、第一阶段：事务协调器要求每个涉及到事务的数据库预提交（precommit）此操作，并反馈可以提交；</p>
<p>b、第二阶段：事务协调器要求每个数据库提交或回滚事务。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609605610807.png" alt="1609605610807"></p>
<p>两阶段提交这种解决方案属于牺牲了一部分可用性来换取的一致性。</p>
<p><strong>优点：</strong> <font color='red'>尽量</font>保证了数据的强一致，适合对数据强一致要求很高的关键领域。（其实也不能100%保证强一致）</p>
<p><strong>缺点：</strong> </p>
<p>&emsp;&emsp;a、同步阻塞：所有事务参与者在等待其他参与者响应的时候都处于同步阻塞的状态，无法进行其他操作；</p>
<p>&emsp;&emsp;b、单点问题：协调者在2PC中起到非常关键的作用，如果发生故障则会造成严重的影响，特别是在第二阶段发生故障，则所有参与者都会一直等待，无法进行其他操作；</p>
<p>&emsp;&emsp;c、数据不一致：在第二阶段，如果协调者只发送了部分commit的消息，那么如果此时发生网络异常，那么就只有部分参与者提交了事务，使得数据不一致（<font color='red'>所有的分布式事务都不是能够完全解决数据不一致的问题，只能说是尽量做到避免数据不一致的情况出现</font>）；</p>
<p>&emsp;&emsp;d、容错率低：任意一个节点失败就会导致整个事务失败，没有完善的容错机制。</p>
<p>XA并不是Java的规范，而是一种通用的规范。而JTA则是满足XA规范的用于Java开发的规范。</p>
<h3 id="2PC的实现——atomikos"><a href="#2PC的实现——atomikos" class="headerlink" title="2PC的实现——atomikos"></a>2PC的实现——atomikos</h3><p>&emsp;&emsp;这里使用<a target="_blank" rel="noopener" href="https://blog.csdn.net/leilei1366615/article/details/104678279%E6%96%87%E7%AB%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80%EF%BC%9Ahttps://cheng_qiwei.gitee.io/blog/resource/file/springboot-mybatis-plus-atomikos.zip%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%8C%E6%9D%A5%E5%90%8C%E6%97%B6%E4%BF%9D%E5%AD%98user%E3%80%81role%E3%80%81userRole%E4%B8%89%E5%BC%A0%E8%A1%A8%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%88%91%E4%BB%AC%E9%A6%96%E5%85%88%E5%B0%86%E5%BC%82%E5%B8%B8%E6%B3%A8%E9%87%8A%EF%BC%8C%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E6%AD%A3%E5%B8%B8%E7%9A%84%E4%BF%9D%E5%AD%98%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%95%B0%E6%8D%AE%E9%83%BD%E8%A2%AB%E6%88%90%E5%8A%9F%E4%BF%9D%E5%AD%98%EF%BC%8C%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%B9%9F%E6%98%AF%E6%A0%B9%E6%8D%AE2PC%E7%9A%84%E8%A7%84%E5%88%99%EF%BC%8C%E5%85%88%E6%89%A7%E8%A1%8C%E9%A2%84%E6%8F%90%E4%BA%A4%EF%BC%8C%E5%86%8D%E6%89%80%E6%9C%89%E9%83%BD%E6%88%90%E5%8A%9F%E5%90%8E%E6%89%A7%E8%A1%8Ccommit%E8%BF%9B%E8%A1%8C%E4%BF%9D%E5%AD%98%E3%80%82">https://blog.csdn.net/leilei1366615/article/details/104678279文章的代码进行测试，完整代码下载地址：https://cheng_qiwei.gitee.io/blog/resource/file/springboot-mybatis-plus-atomikos.zip通过配置多个数据源，来同时保存user、role、userRole三张表的数据，我们首先将异常注释，执行一次正常的保存，我们可以看到，数据都被成功保存，控制台也是根据2PC的规则，先执行预提交，再所有都成功后执行commit进行保存。</a></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609684240746.png" alt="1609684240746"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609684376913.png" alt="1609684376913"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609684452348.png" alt="1609684452348"></p>
<p>&emsp;&emsp;然后我们打开异常，再执行一次，我们可以发现，当出现异常后，前面的数据并没有保存到数据库，而是回滚了，我们通过控制台也可以看见，当执行到异常那一行后，前面两个预提交的事务被注销了，所以就保证了数据的一致性。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609684731890.png" alt="1609684731890"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609684802598.png" alt="1609684802598"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609684923835.png" alt="1609684923835"></p>
<h2 id="3PC（三阶段事务提交）"><a href="#3PC（三阶段事务提交）" class="headerlink" title="3PC（三阶段事务提交）"></a>3PC（三阶段事务提交）</h2><p>&emsp;&emsp;3PC是2PC的升级版，他是在2PC的基础上，<strong>同时在协调者和参与者中都引入了超时机制</strong>。3PC分为以下几个阶段：</p>
<p>a、<strong>cancommit</strong>阶段：类似于2PC的准备阶段，协调者向参与者发送commit请求，参与者如果可以提交就返回Yes响应，否则返回No响应；</p>
<p>b、<strong>preparecommit</strong>阶段：协调者根据参与者的反馈情况来决定是否可以执行事务PreCommit操作；</p>
<p>c、<strong>doCommit</strong>阶段:该阶段进行真正的事务提交。该阶段进行真正的事务提交，也可以分为以下两种情况。</p>
<p>&emsp;&emsp;c1、执行提交，参与者首先发送提交请求协调接收到参与者发送的ACK响应，那么协调者将从预提交状态进入到提交状态。并向所有参与者发送doCommit请求。参与者接收到doCommit请求之后，执行正式的事务提交，并在完成事务提交之后释放所有事务资源。接着事务提交完之后，参与者向协调者发送Ack响应。最后协调者接收到所有参与者的ack响应之后，完成事务。</p>
<p>&emsp;&emsp;c2、中断事务，协调者没有接收到参与者发送的ACK响应。（可能是接受者发送的不是ACK响应，也可能响应超时）。协调者向所有参与者发送终止请求，参与者在接收到终止请求后，会利用其在二阶段记录的信息来执行事务回滚操作，并在完成事务回滚之后释放所有事务资源。回滚之后，向协调者发送Ack信息，中断事务。</p>
<p>&emsp;&emsp;<font color='red'>注意事项：在阶段三，会出现以下两种故障，第一是协调者出现问题，第二是协调者和参与者之间的网络出现故障。但无论是哪种情况，最终都会导致参与者无法及时接收来自协调者的提交或回滚的请求，针对这种情况，3PC的解决方案是在参与者等待超时之后，会继续对事物进行commit操作，这样的操作相对于2PC中继续等待来讲是降低了参与者的阻塞范围，但这样操作后必然出现数据不一致性。</font></p>
<p><font size='5px'><strong>柔性事务</strong></font></p>
<h2 id="TCC（Try-Confirm-Cancel）两阶段补偿性方案"><a href="#TCC（Try-Confirm-Cancel）两阶段补偿性方案" class="headerlink" title="TCC（Try-Confirm-Cancel）两阶段补偿性方案"></a>TCC（Try-Confirm-Cancel）两阶段补偿性方案</h2><p> &emsp;&emsp;TCC 也是2PC的一种变体，其实就是采用的补偿机制，其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。TCC主要分为三个阶段：</p>
<p>&emsp;&emsp;Try阶段：对业务系统做检测及资源预留；</p>
<p>&emsp;&emsp;Confirm阶段：对业务系统做确认提交，Try阶段执行成功并开始执行confirm阶段时，默认confirm阶段是不会出错的；</p>
<p>&emsp;&emsp;Cancel阶段：在业务执行错误时，需要回滚的时候执行的业务取消并将预留的资源释放。</p>
<p><strong>根据上面的描述，我们举个栗子：</strong></p>
<p>&emsp;&emsp;假设有一个支付订单的场景：当我们支付完一笔订单后，我们需要进行以下几个步骤的操作</p>
<p>&emsp;&emsp;&emsp;a、更改订单状态为已支付；</p>
<p>&emsp;&emsp;&emsp;b、扣减商品库存；</p>
<p>&emsp;&emsp;&emsp;c、会员增加积分；</p>
<p>&emsp;&emsp;&emsp;d、创建销售单。</p>
<p>&emsp;&emsp;那么，我们现在肯定希望的效果是，上述几个步骤在一次操作中同时成功或同时失败，必须是一个整体性的事务。但是，但我们上述这几个操作都在不同的服务上，且系统无进行任何分布式事务处理时，当我们已经执行了更改订单状态，扣减商品库存之后，会员积分服务突然挂了，此时后面的创建销售单操作也无法执行，但是订单状态已经更改，商品库存已经扣除，这就出现了数据不一致的问题。</p>
<p>&emsp;&emsp;现在，我们来使用TCC对我们的项目进行改造，首先是T（Try）阶段，这个阶段，我们不是直接一步到位就把订单状态给改了或者对商品数量接直接给减了，而是一个预备的过程。例如按照我们上面的例子来讲，我们可以首先将订单更改为支付中的一个状态，扣减商品库存也不是真的扣减，而是增加一个字段，用来先保存我们扣减的商品的数量，积分也是增加字段，用来保存增加的积分……，这一步执行的真正目的除了保留了一些需要使用的资源（例如冻结部分资源）以外，也确保了底层的数据源（数据库、redis、es）等都是正常的。</p>
<p>&emsp;&emsp;接着，到了C（Confirm）阶段，如果第一阶段运行顺利，所有操作都成功了，那么就可以执行Confirm阶段的操作，正式把数据修改到数据库，比如说，把订单修改为已支付，扣减商品库存，增加积分……，同时将预备的数据清除掉。</p>
<p>&emsp;&emsp;上面的C是指正常情况下的处理方法，那么如果出现异常呢？例如上面说的会员积分服务突然挂了，那么就需要第二个C（Cancel）阶段来处理了，该阶段，我们需要把之前半修改的数据修改回来，例如说，把订单支付中的状态修改为待支付的状态，保存商品扣减数量的字段删除对应的数量……，这样就回滚了数据，保证了数据的一致性。</p>
<p>&emsp;&emsp;那么，根据上述内容，如果某个服务突然发生意外，然后进行重启，TCC是如何保证之前没有执行的分布式事务继续执行呢？如果某个服务一直Confirm或cancel失败怎么办？其实，事务框架都是需要记录各个服务的状态，可以在文件或数据库进行记录，保存分布式事务运行的各个状态，可以通过日志记录进行重试，使其成功，且如果第一步try如果成功进行的话，如果不是代码有bug的话，一般不会出现Confirm或cancel失败的情况。</p>
<p><strong>TCC的优点及缺点</strong></p>
<p>&emsp;&emsp;<strong>优点：</strong> 跟2PC比起来，实现以及流程相对简单了一些，但数据的一致性比2PC也要差一些；</p>
<p>&emsp;&emsp;<strong>缺点：</strong> 缺点还是比较明显的，在2,3步中都有可能失败。TCC属于应用层的一种补偿方式，所以需要程序员在实现的时候多写很多补偿的代码，在一些场景中，一些业务流程可能用TCC不太好定义及处理。</p>
<h1 id="springCloudAlibaba——Seata"><a href="#springCloudAlibaba——Seata" class="headerlink" title="springCloudAlibaba——Seata"></a>springCloudAlibaba——Seata</h1><p>&emsp;&emsp;Seata 是一款Alibaba开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>
<h2 id="Seata的重要概念"><a href="#Seata的重要概念" class="headerlink" title="Seata的重要概念"></a>Seata的重要概念</h2><h3 id="TC-Transaction-Coordinator-事务协调者"><a href="#TC-Transaction-Coordinator-事务协调者" class="headerlink" title="TC (Transaction Coordinator) - 事务协调者"></a>TC (Transaction Coordinator) - 事务协调者</h3><p>&emsp;&emsp;维护全局和分支事务的状态，驱动全局事务提交或回滚。</p>
<h3 id="TM-Transaction-Manager-事务管理器"><a href="#TM-Transaction-Manager-事务管理器" class="headerlink" title="TM (Transaction Manager) - 事务管理器"></a>TM (Transaction Manager) - 事务管理器</h3><p>&emsp;&emsp;定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p>
<h3 id="RM-Resource-Manager-资源管理器"><a href="#RM-Resource-Manager-资源管理器" class="headerlink" title="RM (Resource Manager) - 资源管理器"></a>RM (Resource Manager) - 资源管理器</h3><p>&emsp;&emsp;管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
<h3 id="Transaction-ID：XID"><a href="#Transaction-ID：XID" class="headerlink" title="Transaction ID：XID"></a>Transaction ID：XID</h3><p>&emsp;&emsp;全局唯一的事务ID</p>
<h2 id="Seata的工作流程"><a href="#Seata的工作流程" class="headerlink" title="Seata的工作流程"></a>Seata的工作流程</h2><p>1、TM向TC申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID；</p>
<p>2、XID在微服务调用链路的上下文中传播（也就是在多个TM、RM中传播）；</p>
<p>3、RM向TC注册分支事务，将其纳入XID对应全局事务的管辖；</p>
<p>4、TM向TC发起针对XID的全局提交或回滚决议；</p>
<p>5、TC调度XID下管辖的全部分支事务完成提交或回滚请求。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609076518331.png" alt="1609076518331"></p>
<h1 id="Seata的安装"><a href="#Seata的安装" class="headerlink" title="Seata的安装"></a>Seata的安装</h1><h2 id="下载Seata安装包"><a href="#下载Seata安装包" class="headerlink" title="下载Seata安装包"></a>下载Seata安装包</h2><p><a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases/tag/v1.4.0">https://github.com/seata/seata/releases/tag/v1.4.0</a></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609076589809.png" alt="1609076589809"></p>
<p>将下载的文件上传到linux虚拟机中</p>
<h2 id="解压压缩包"><a href="#解压压缩包" class="headerlink" title="解压压缩包"></a>解压压缩包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf seata-server-1.4.0.tar.gz </span><br></pre></td></tr></table></figure>

<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><h3 id="修改file-conf"><a href="#修改file-conf" class="headerlink" title="修改file.conf"></a>修改file.conf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim conf/file.conf</span><br></pre></td></tr></table></figure>

<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609076769140.png" alt="1609076769140">d </p>
<h3 id="修改registry-conf"><a href="#修改registry-conf" class="headerlink" title="修改registry.conf"></a>修改registry.conf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim conf/registry.conf</span><br></pre></td></tr></table></figure>



<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609076869739.png" alt="1609076869739"></p>
<h3 id="配置数据库"><a href="#配置数据库" class="headerlink" title="配置数据库"></a>配置数据库</h3><p>由于1.4.0版本没有配置对应的sql文件，所以在下边附上，创建一个名为seata的数据库，然后复制下面的内容执行即可。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`global_table`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`global_table`</span> (</span><br><span class="line">  <span class="string">`xid`</span> <span class="built_in">VARCHAR</span>(<span class="number">128</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`transaction_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">TINYINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`application_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  <span class="string">`transaction_service_group`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  <span class="string">`transaction_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">  <span class="string">`timeout`</span> <span class="built_in">INT</span>,</span><br><span class="line">  <span class="string">`begin_time`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`application_data`</span> <span class="built_in">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">  <span class="string">`gmt_create`</span> DATETIME,</span><br><span class="line">  <span class="string">`gmt_modified`</span> DATETIME,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`xid`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_gmt_modified_status`</span> (<span class="string">`gmt_modified`</span>, <span class="string">`status`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_transaction_id`</span> (<span class="string">`transaction_id`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`branch_table`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`branch_table`</span> (</span><br><span class="line">  <span class="string">`branch_id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`xid`</span> <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`transaction_id`</span> <span class="built_in">BIGINT</span> ,</span><br><span class="line">  <span class="string">`resource_group_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  <span class="string">`resource_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">256</span>) ,</span><br><span class="line">  <span class="string">`lock_key`</span> <span class="built_in">VARCHAR</span>(<span class="number">128</span>) ,</span><br><span class="line">  <span class="string">`branch_type`</span> <span class="built_in">VARCHAR</span>(<span class="number">8</span>) ,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">TINYINT</span>,</span><br><span class="line">  <span class="string">`client_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  <span class="string">`application_data`</span> <span class="built_in">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">  <span class="string">`gmt_create`</span> DATETIME,</span><br><span class="line">  <span class="string">`gmt_modified`</span> DATETIME,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`branch_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_xid`</span> (<span class="string">`xid`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`lock_table`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`lock_table`</span> (</span><br><span class="line">  <span class="string">`row_key`</span> <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`xid`</span> <span class="built_in">VARCHAR</span>(<span class="number">96</span>),</span><br><span class="line">  <span class="string">`transaction_id`</span> <span class="keyword">LONG</span> ,</span><br><span class="line">  <span class="string">`branch_id`</span> <span class="keyword">LONG</span>,</span><br><span class="line">  <span class="string">`resource_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">256</span>) ,</span><br><span class="line">  <span class="string">`table_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) ,</span><br><span class="line">  <span class="string">`pk`</span> <span class="built_in">VARCHAR</span>(<span class="number">36</span>) ,</span><br><span class="line">  <span class="string">`gmt_create`</span> DATETIME ,</span><br><span class="line">  <span class="string">`gmt_modified`</span> DATETIME,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span>(<span class="string">`row_key`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./root/seata/bin/seata-server.sh</span><br></pre></td></tr></table></figure>

<p><img src="http://cheng_qiwei.gitee.io/blog/img/1609077056733.png" alt="1609077056733"></p>
<h1 id="Seata的使用"><a href="#Seata的使用" class="headerlink" title="Seata的使用"></a>Seata的使用</h1><h2 id="数据库的准备"><a href="#数据库的准备" class="headerlink" title="数据库的准备"></a>数据库的准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seata_order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_order(</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	<span class="string">`user_id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">	<span class="string">`product_id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;产品id&#x27;</span>,</span><br><span class="line">	<span class="string">`count`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">	<span class="string">`money`</span> <span class="built_in">DECIMAL</span>(<span class="number">11</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;金额&#x27;</span>,</span><br><span class="line">	<span class="string">`status`</span> <span class="built_in">INT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;订单状态：0：创建中; 1：已完结&#x27;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">7</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"><span class="comment">-------------------------------------------------------------------------------------- </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seata_storage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_storage(</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	<span class="string">`product_id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;产品id&#x27;</span>,</span><br><span class="line">	<span class="string">`total`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;总库存&#x27;</span>,</span><br><span class="line">	<span class="string">`used`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;已用库存&#x27;</span>,</span><br><span class="line">	<span class="string">`residue`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;剩余库存&#x27;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_storage(<span class="string">`id`</span>,<span class="string">`product_id`</span>,<span class="string">`total`</span>,<span class="string">`used`</span>,<span class="string">`residue`</span>)<span class="keyword">VALUES</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;100&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-------------------------------------------------------------------------------------- </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seata_account;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_account(</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">	<span class="string">`user_id`</span> <span class="built_in">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">	<span class="string">`total`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;总额度&#x27;</span>,</span><br><span class="line">	<span class="string">`used`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;已用余额&#x27;</span>,</span><br><span class="line">	<span class="string">`residue`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;剩余可用额度&#x27;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_account(<span class="string">`id`</span>,<span class="string">`user_id`</span>,<span class="string">`total`</span>,<span class="string">`used`</span>,<span class="string">`residue`</span>) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1000</span>,<span class="number">0</span>,<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<h2 id="在每个数据库添加日志信息回滚表"><a href="#在每个数据库添加日志信息回滚表" class="headerlink" title="在每个数据库添加日志信息回滚表"></a>在每个数据库添加日志信息回滚表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`undo_log`</span> (</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	<span class="string">`branch_id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`xid`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`context`</span> <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`rollback_info`</span> LONGBLOB <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`log_status`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`log_created`</span> DATETIME <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`log_modified`</span> DATETIME <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`ext`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">	<span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`ux_undo_log`</span> (<span class="string">`xid`</span>,<span class="string">`branch_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<p>最终效果展示：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1610271710787.png" alt="1610271710787"></p>
<h2 id="在nacos中添加各个微服务的配置"><a href="#在nacos中添加各个微服务的配置" class="headerlink" title="在nacos中添加各个微服务的配置"></a>在nacos中添加各个微服务的配置</h2><p>该步骤在以前的版本是将上面3.1和3.2的文件拷贝到每个微服务的resources目录下，到了现在的版本就可以配置到nacos上</p>
<h3 id="添加脚本nacos-config-sh到seata的conf"><a href="#添加脚本nacos-config-sh到seata的conf" class="headerlink" title="添加脚本nacos-config.sh到seata的conf"></a>添加脚本nacos-config.sh到seata的conf</h3><p><a href = 'https://github.com/seata/seata/blob/develop/script/config-center/nacos/nacos-config.sh'>获取地址点击此链接</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">opyright 1999-2019 Seata.io Group.</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you may not use this file except <span class="keyword">in</span> compliance with the License.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You may obtain a copy of the License at、</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">&quot;AS IS&quot;</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"></span><br><span class="line">while getopts &quot;:h:p:g:t:u:w:&quot; opt</span><br><span class="line">do</span><br><span class="line">  case $opt in</span><br><span class="line">  h)</span><br><span class="line">    host=$OPTARG</span><br><span class="line">    ;;</span><br><span class="line">  p)</span><br><span class="line">    port=$OPTARG</span><br><span class="line">    ;;</span><br><span class="line">  g)</span><br><span class="line">    group=$OPTARG</span><br><span class="line">    ;;</span><br><span class="line">  t)</span><br><span class="line">    tenant=$OPTARG</span><br><span class="line">    ;;</span><br><span class="line">  u)</span><br><span class="line">    username=$OPTARG</span><br><span class="line">    ;;</span><br><span class="line">  w)</span><br><span class="line">    password=$OPTARG</span><br><span class="line">    ;;</span><br><span class="line">  ?)</span><br><span class="line">    echo &quot; USAGE OPTION: $0 [-h host] [-p port] [-g group] [-t tenant] [-u username] [-w password] &quot;</span><br><span class="line">    exit 1</span><br><span class="line">    ;;</span><br><span class="line">  esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">urlencode() &#123;</span><br><span class="line">  for ((i=0; i &lt; $&#123;#1&#125;; i++))</span><br><span class="line">  do</span><br><span class="line">    char=&quot;$&#123;1:$i:1&#125;&quot;</span><br><span class="line">    case $char in</span><br><span class="line">    [a-zA-Z0-9.~_-]) printf $char ;;</span><br><span class="line">    *) printf &#x27;%%%02X&#x27; &quot;&#x27;$char&quot; ;;</span><br><span class="line">    esac</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [[ -z $&#123;host&#125; ]]; then</span><br><span class="line">    host=localhost</span><br><span class="line">fi</span><br><span class="line">if [[ -z $&#123;port&#125; ]]; then</span><br><span class="line">    port=8848</span><br><span class="line">fi</span><br><span class="line">if [[ -z $&#123;group&#125; ]]; then</span><br><span class="line">    group=&quot;SEATA_GROUP&quot;</span><br><span class="line">fi</span><br><span class="line">if [[ -z $&#123;tenant&#125; ]]; then</span><br><span class="line">    tenant=&quot;&quot;</span><br><span class="line">fi</span><br><span class="line">if [[ -z $&#123;username&#125; ]]; then</span><br><span class="line">    username=&quot;&quot;</span><br><span class="line">fi</span><br><span class="line">if [[ -z $&#123;password&#125; ]]; then</span><br><span class="line">    password=&quot;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">nacosAddr=$host:$port</span><br><span class="line">contentType=&quot;content-type:application/json;charset=UTF-8&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;set nacosAddr=$nacosAddr&quot;</span><br><span class="line">echo &quot;set group=$group&quot;</span><br><span class="line"></span><br><span class="line">failCount=0</span><br><span class="line">tempLog=$(mktemp -u)</span><br><span class="line">function addConfig() &#123;</span><br><span class="line">  curl -X POST -H &quot;$&#123;contentType&#125;&quot; &quot;http://$nacosAddr/nacos/v1/cs/configs?dataId=$(urlencode $1)&amp;group=$group&amp;content=$(urlencode $2)&amp;tenant=$tenant&amp;username=$username&amp;password=$password&quot; &gt;&quot;$&#123;tempLog&#125;&quot; 2&gt;/dev/null</span><br><span class="line">  if [[ -z $(cat &quot;$&#123;tempLog&#125;&quot;) ]]; then</span><br><span class="line">    echo &quot; Please check the cluster status. &quot;</span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">  if [[ $(cat &quot;$&#123;tempLog&#125;&quot;) =~ &quot;true&quot; ]]; then</span><br><span class="line">    echo &quot;Set $1=$2 successfully &quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;Set $1=$2 failure &quot;</span><br><span class="line">    (( failCount++ ))</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">count=0</span><br><span class="line">for line in $(cat $(dirname &quot;$PWD&quot;)/conf/config.txt | sed s/[[:space:]]//g); do</span><br><span class="line">  (( count++ ))</span><br><span class="line">	key=$&#123;line%%=*&#125;</span><br><span class="line">    value=$&#123;line#*=&#125;</span><br><span class="line">	addConfig &quot;$&#123;key&#125;&quot; &quot;$&#123;value&#125;&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &quot;=========================================================================&quot;</span><br><span class="line">echo &quot; Complete initialization parameters,  total-count:$count ,  failure-count:$failCount &quot;</span><br><span class="line">echo &quot;=========================================================================&quot;</span><br><span class="line"></span><br><span class="line">if [[ $&#123;failCount&#125; -eq 0 ]]; then</span><br><span class="line">	echo &quot; Init nacos config finished, please start seata-server. &quot;</span><br><span class="line">else</span><br><span class="line">	echo &quot; init nacos config fail. &quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h3 id="添加配置文件config-txt到seata的conf目录"><a href="#添加配置文件config-txt到seata的conf目录" class="headerlink" title="添加配置文件config.txt到seata的conf目录"></a>添加配置文件config.txt到seata的conf目录</h3><p><a href = 'https://github.com/seata/seata/blob/develop/script/config-center/config.txt'>获取地址点击此链接</a></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">transport.type=TCP</span><br><span class="line">transport.server=NIO</span><br><span class="line">transport.heartbeat=true</span><br><span class="line">transport.enableClientBatchSendRequest=false</span><br><span class="line">transport.threadFactory.bossThreadPrefix=NettyBoss</span><br><span class="line">transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker</span><br><span class="line">transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler</span><br><span class="line">transport.threadFactory.shareBossWorker=false</span><br><span class="line">transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector</span><br><span class="line">transport.threadFactory.clientSelectorThreadSize=1</span><br><span class="line">transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread</span><br><span class="line">transport.threadFactory.bossThreadSize=1</span><br><span class="line">transport.threadFactory.workerThreadSize=default</span><br><span class="line">transport.shutdown.wait=3</span><br><span class="line">service.vgroupMapping.my_test_tx_group=default</span><br><span class="line">service.default.grouplist=127.0.0.1:8091</span><br><span class="line">service.enableDegrade=false</span><br><span class="line">service.disableGlobalTransaction=false</span><br><span class="line">client.rm.asyncCommitBufferLimit=10000</span><br><span class="line">client.rm.lock.retryInterval=10</span><br><span class="line">client.rm.lock.retryTimes=30</span><br><span class="line">client.rm.lock.retryPolicyBranchRollbackOnConflict=true</span><br><span class="line">client.rm.reportRetryCount=5</span><br><span class="line">client.rm.tableMetaCheckEnable=false</span><br><span class="line">client.rm.tableMetaCheckerInterval=60000</span><br><span class="line">client.rm.sqlParserType=druid</span><br><span class="line">client.rm.reportSuccessEnable=false</span><br><span class="line">client.rm.sagaBranchRegisterEnable=false</span><br><span class="line">client.tm.commitRetryCount=5</span><br><span class="line">client.tm.rollbackRetryCount=5</span><br><span class="line">client.tm.defaultGlobalTransactionTimeout=60000</span><br><span class="line">client.tm.degradeCheck=false</span><br><span class="line">client.tm.degradeCheckAllowTimes=10</span><br><span class="line">client.tm.degradeCheckPeriod=2000</span><br><span class="line">store.mode=file</span><br><span class="line">store.publicKey=1</span><br><span class="line">store.file.dir=file_store/data</span><br><span class="line">store.file.maxBranchSessionSize=16384</span><br><span class="line">store.file.maxGlobalSessionSize=512</span><br><span class="line">store.file.fileWriteBufferCacheSize=16384</span><br><span class="line">store.file.flushDiskMode=async</span><br><span class="line">store.file.sessionReloadReadSize=100</span><br><span class="line">store.db.datasource=druid</span><br><span class="line">store.db.dbType=mysql</span><br><span class="line">store.db.driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">store.db.url=jdbc:mysql://127.0.0.1:3306/seata_order?useUnicode=true&amp;rewriteBatchedStatements=true</span><br><span class="line">store.db.user=root</span><br><span class="line">store.db.password=123456</span><br><span class="line">store.db.minConn=5</span><br><span class="line">store.db.maxConn=30</span><br><span class="line">store.db.globalTable=global_table</span><br><span class="line">store.db.branchTable=branch_table</span><br><span class="line">store.db.queryLimit=100</span><br><span class="line">store.db.lockTable=lock_table</span><br><span class="line">store.db.maxWait=5000</span><br><span class="line">store.redis.mode=single</span><br><span class="line">store.redis.single.host=127.0.0.1</span><br><span class="line">store.redis.single.port=6379</span><br><span class="line">store.redis.maxConn=10</span><br><span class="line">store.redis.minConn=1</span><br><span class="line">store.redis.maxTotal=100</span><br><span class="line">store.redis.database=0</span><br><span class="line">store.redis.password=123456</span><br><span class="line">store.redis.queryLimit=100</span><br><span class="line">server.recovery.committingRetryPeriod=1000</span><br><span class="line">server.recovery.asynCommittingRetryPeriod=1000</span><br><span class="line">server.recovery.rollbackingRetryPeriod=1000</span><br><span class="line">server.recovery.timeoutRetryPeriod=1000</span><br><span class="line">server.maxCommitRetryTimeout=-1</span><br><span class="line">server.maxRollbackRetryTimeout=-1</span><br><span class="line">server.rollbackRetryTimeoutUnlockEnable=false</span><br><span class="line">client.undo.dataValidation=true</span><br><span class="line">client.undo.logSerialization=jackson</span><br><span class="line">client.undo.onlyCareUpdateColumns=true</span><br><span class="line">server.undo.logSaveDays=7</span><br><span class="line">server.undo.logDeletePeriod=86400000</span><br><span class="line">client.undo.logTable=undo_log</span><br><span class="line">client.undo.compress.enable=true</span><br><span class="line">client.undo.compress.type=zip</span><br><span class="line">client.undo.compress.threshold=64k</span><br><span class="line">log.exceptionRate=100</span><br><span class="line">transport.serialization=seata</span><br><span class="line">transport.compressor=none</span><br><span class="line">metrics.enabled=false</span><br><span class="line">metrics.registryType=compact</span><br><span class="line">metrics.exporterList=prometheus</span><br><span class="line">metrics.exporterPrometheusPort=9898</span><br></pre></td></tr></table></figure>

<p>最重要的配置</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611586102169.png" alt="1611586102169"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611586065601.png" alt="1611586065601"></p>
<h3 id="3-3、执行命令将配置保存到nacos中"><a href="#3-3、执行命令将配置保存到nacos中" class="headerlink" title="3.3、执行命令将配置保存到nacos中"></a>3.3、执行命令将配置保存到nacos中</h3><p>由于配置相当多，所以最好是建立一个单独的空间来保存</p>
<p>该命令中 -t表示需要保存的空间，如果没有限制用户名和密码，则-u和-w这两个可以去掉</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh nacos-config.sh -h 127.0.0.1 -p 8848 -g SEATA_GROUP -t a82700f8-03c7-4b00-8ff7-95b51fee96cf -u nacos -w nacos</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611586837335.png" alt="1611586837335"></p>
<p>后续如果有需要修改的地方，可以在nacos直接修改，不需要重新执行脚本</p>
<h2 id="创建seata-order、seata-account、seata-storage三个微服务"><a href="#创建seata-order、seata-account、seata-storage三个微服务" class="headerlink" title="创建seata-order、seata-account、seata-storage三个微服务"></a>创建seata-order、seata-account、seata-storage三个微服务</h2><p>这里只说重要配置，详细可参考源码</p>
<h3 id="pom文件引入seata"><a href="#pom文件引入seata" class="headerlink" title="pom文件引入seata"></a>pom文件引入seata</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enable-auto-data-source-proxy:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">my_test_tx_group</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">$&#123;linux.ip&#125;:80</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">&quot;a82700f8-03c7-4b00-8ff7-95b51fee96cf&quot;</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">$&#123;linux.ip&#125;:80</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span></span><br><span class="line">      <span class="attr">my_test_tx_group:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">grouplist:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="string">$&#123;linux.ip&#125;:8091</span></span><br><span class="line">    <span class="attr">disable-global-transaction:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">rm:</span></span><br><span class="line">      <span class="attr">report-success-enable:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611587920538.png" alt="1611587920538"></p>
<h3 id="在需要进行分布式操作的接口上添加-GlobalTransactional注解"><a href="#在需要进行分布式操作的接口上添加-GlobalTransactional注解" class="headerlink" title="在需要进行分布式操作的接口上添加@GlobalTransactional注解"></a>在需要进行分布式操作的接口上添加@GlobalTransactional注解</h3><p><img src="http://cheng_qiwei.gitee.io/blog/img/1611672434484.png" alt="1611672434484"></p>
<p><font color='red'><strong>注意各个服务的服务都必须配置和seata-server在相同的空间中，否则后续会出现各种奇怪的问题</strong></font></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611588088719.png" alt="1611588088719"></p>
<p><font color='red'><strong>服务启动后，seata的服务端会有RM和TM连接的展示</strong></font></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611670632746.png" alt="1611670632746"></p>
<p><font color='red'><strong>各个子服务也有相应连接</strong></font></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611670859404.png" alt="1611670859404"></p>
<p>测试</p>
<p>1、测试创建订单   <a target="_blank" rel="noopener" href="http://127.0.0.1:8801/order/create">http://127.0.0.1:8801/order/create</a></p>
<p>首先测试正常情况下，订单生成成功，库存扣减、账户扣减成功</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611671241904.png" alt="1611671241904"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611671236685.png" alt="1611671236685"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611671770888.png" alt="1611671770888"></p>
<p>接着，测试不正常的情况，我们把数量设置为100，因为我们当前的库存已经不足100，所以此时扣减100库存的话，就会发生意外，但是，由于订单已经生成，如果seata的分布式事务有效的话，我们的订单就应该能够回滚成功。我们发现异常后，查看数据库，订单为保存，库存和余额也没有扣减，分布式事务生效。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611671328435.png" alt="1611671328435"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611671426528.png" alt="1611671426528"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611671904291.png" alt="1611671904291"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/1611671990045.png" alt="1611671990045"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">WinKing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://cheng_qiwei.gitee.io/blog/2021/03/15/Seata%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/">http://cheng_qiwei.gitee.io/blog/2021/03/15/Seata%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cheng_qiwei.gitee.io/blog" target="_blank">WinKings Blogs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">分布式事务</a><a class="post-meta__tags" href="/blog/tags/Seata/">Seata</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=null" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/2021/03/15/Linux%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux安装软件</div></div></a></div><div class="next-post pull-right"><a href="/blog/2021/03/05/JDK8%E6%96%B0%E7%89%B9%E6%80%A7%E2%80%94%E2%80%94%E6%97%B6%E9%97%B4%E7%B1%BB/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JDK8新特性——时间类</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/blog/img/touxiang.jpg" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">WinKing</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">25</div></a></div><div class="card-info-data-item is-center"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">48</div></a></div><div class="card-info-data-item is-center"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/cheng_qiwei"><i class="fab fa-gitee"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%92%8CAlibaba-Seata%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-text">分布式事务和Alibaba  Seata的介绍和使用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%9F"><span class="toc-text">什么是分布式事务？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%9F"><span class="toc-text">分布式事务产生的原因？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0%E4%B8%80%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-text">原因一：数据库的分库分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0%E4%BA%8C%EF%BC%9A%E5%BA%94%E7%94%A8SOA%E5%8C%96"><span class="toc-text">原因二：应用SOA化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA"><span class="toc-text">分布式理论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP%E5%AE%9A%E7%90%86"><span class="toc-text">CAP定理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP%E5%B1%9E%E6%80%A7%E8%A7%A3%E8%AF%BB"><span class="toc-text">CAP属性解读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E4%B8%8E%E5%8F%AF%E7%94%A8%E6%80%A7%E7%9A%84%E7%9F%9B%E7%9B%BE"><span class="toc-text">一致性与可用性的矛盾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP%E7%89%B9%E6%80%A7%E7%9A%84%E5%8F%96%E8%88%8D%E7%AD%96%E7%95%A5"><span class="toc-text">CAP特性的取舍策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BASE%E7%90%86%E8%AE%BA"><span class="toc-text">BASE理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFBASE%E7%90%86%E8%AE%BA"><span class="toc-text">什么是BASE理论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%88Basically-Available%EF%BC%89"><span class="toc-text">基本可用性（Basically Available）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E7%8A%B6%E6%80%81%EF%BC%88Soft-state%EF%BC%89"><span class="toc-text">软状态（Soft state）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Eventual-Consitency%EF%BC%89"><span class="toc-text">最终一致性（Eventual Consitency）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">分布式事务的解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2PC%EF%BC%88-XA-Transactions%EF%BC%89"><span class="toc-text">2PC（ XA Transactions）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2PC%E7%9A%84%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94atomikos"><span class="toc-text">2PC的实现——atomikos</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3PC%EF%BC%88%E4%B8%89%E9%98%B6%E6%AE%B5%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%EF%BC%89"><span class="toc-text">3PC（三阶段事务提交）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCC%EF%BC%88Try-Confirm-Cancel%EF%BC%89%E4%B8%A4%E9%98%B6%E6%AE%B5%E8%A1%A5%E5%81%BF%E6%80%A7%E6%96%B9%E6%A1%88"><span class="toc-text">TCC（Try-Confirm-Cancel）两阶段补偿性方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#springCloudAlibaba%E2%80%94%E2%80%94Seata"><span class="toc-text">springCloudAlibaba——Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata%E7%9A%84%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="toc-text">Seata的重要概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TC-Transaction-Coordinator-%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E8%80%85"><span class="toc-text">TC (Transaction Coordinator) - 事务协调者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TM-Transaction-Manager-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">TM (Transaction Manager) - 事务管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RM-Resource-Manager-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">RM (Resource Manager) - 资源管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Transaction-ID%EF%BC%9AXID"><span class="toc-text">Transaction ID：XID</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">Seata的工作流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Seata%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-text">Seata的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDSeata%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-text">下载Seata安装包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B%E5%8E%8B%E7%BC%A9%E5%8C%85"><span class="toc-text">解压压缩包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-text">修改配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9file-conf"><span class="toc-text">修改file.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9registry-conf"><span class="toc-text">修改registry.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">配置数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-text">启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Seata%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">Seata的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-text">数据库的准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%AF%8F%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF%E5%9B%9E%E6%BB%9A%E8%A1%A8"><span class="toc-text">在每个数据库添加日志信息回滚表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8nacos%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%90%84%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-text">在nacos中添加各个微服务的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%84%9A%E6%9C%ACnacos-config-sh%E5%88%B0seata%E7%9A%84conf"><span class="toc-text">添加脚本nacos-config.sh到seata的conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6config-txt%E5%88%B0seata%E7%9A%84conf%E7%9B%AE%E5%BD%95"><span class="toc-text">添加配置文件config.txt到seata的conf目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%E3%80%81%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E5%B0%86%E9%85%8D%E7%BD%AE%E4%BF%9D%E5%AD%98%E5%88%B0nacos%E4%B8%AD"><span class="toc-text">3.3、执行命令将配置保存到nacos中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAseata-order%E3%80%81seata-account%E3%80%81seata-storage%E4%B8%89%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">创建seata-order、seata-account、seata-storage三个微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom%E6%96%87%E4%BB%B6%E5%BC%95%E5%85%A5seata"><span class="toc-text">pom文件引入seata</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#application-yml"><span class="toc-text">application.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E5%88%86%E5%B8%83%E5%BC%8F%E6%93%8D%E4%BD%9C%E7%9A%84%E6%8E%A5%E5%8F%A3%E4%B8%8A%E6%B7%BB%E5%8A%A0-GlobalTransactional%E6%B3%A8%E8%A7%A3"><span class="toc-text">在需要进行分布式操作的接口上添加@GlobalTransactional注解</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/" title="zookeeper详解"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="zookeeper详解"/></a><div class="content"><a class="title" href="/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/" title="zookeeper详解">zookeeper详解</a><time datetime="2021-07-25T14:00:00.000Z" title="发表于 2021-07-25 22:00:00">2021-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/07/10/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E5%88%86%E5%8C%BA%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94Hash%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7Hash/" title="分布式缓存分区算法——Hash与一致性Hash"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="分布式缓存分区算法——Hash与一致性Hash"/></a><div class="content"><a class="title" href="/blog/2021/07/10/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E5%88%86%E5%8C%BA%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94Hash%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7Hash/" title="分布式缓存分区算法——Hash与一致性Hash">分布式缓存分区算法——Hash与一致性Hash</a><time datetime="2021-07-10T14:00:00.000Z" title="发表于 2021-07-10 22:00:00">2021-07-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/30/Redis%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%8C%BA/" title="Redis集群与分区"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis集群与分区"/></a><div class="content"><a class="title" href="/blog/2021/06/30/Redis%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%8C%BA/" title="Redis集群与分区">Redis集群与分区</a><time datetime="2021-06-30T14:00:00.000Z" title="发表于 2021-06-30 22:00:00">2021-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/14/Redis%E7%9A%84%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" title="Redis的进阶使用"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis的进阶使用"/></a><div class="content"><a class="title" href="/blog/2021/06/14/Redis%E7%9A%84%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" title="Redis的进阶使用">Redis的进阶使用</a><time datetime="2021-06-14T14:00:00.000Z" title="发表于 2021-06-14 22:00:00">2021-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/07/Redis%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%91%BD%E4%BB%A4/" title="Redis介绍与命令"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis介绍与命令"/></a><div class="content"><a class="title" href="/blog/2021/06/07/Redis%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%91%BD%E4%BB%A4/" title="Redis介绍与命令">Redis介绍与命令</a><time datetime="2021-06-07T14:00:00.000Z" title="发表于 2021-06-07 22:00:00">2021-06-07</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By WinKing</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="/blog/js/tw_cn.js"></script><script src="/blog/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script></div></body></html>