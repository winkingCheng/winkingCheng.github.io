<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>zookeeper详解 | WinKings Blogs</title><meta name="keywords" content="zookeeper,原理,应用"><meta name="author" content="WinKing"><meta name="copyright" content="WinKing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="zookeeper介绍一、zookeeper简介 官网：https:&#x2F;&#x2F;zookeeper.apache.org&#x2F;doc&#x2F;current&#x2F;index.html  1、zookeeper是什么？&amp;emsp;&amp;emsp;zookeeper是高性能的分布式协作服务和分布式数据一致性解决方案，由雅虎创建，是Goole Chubby的开源实现。 &amp;emsp;&amp;emsp;zookeeper可以保证分布式一致性">
<meta property="og:type" content="article">
<meta property="og:title" content="zookeeper详解">
<meta property="og:url" content="http://cheng_qiwei.gitee.io/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/index.html">
<meta property="og:site_name" content="WinKings Blogs">
<meta property="og:description" content="zookeeper介绍一、zookeeper简介 官网：https:&#x2F;&#x2F;zookeeper.apache.org&#x2F;doc&#x2F;current&#x2F;index.html  1、zookeeper是什么？&amp;emsp;&amp;emsp;zookeeper是高性能的分布式协作服务和分布式数据一致性解决方案，由雅虎创建，是Goole Chubby的开源实现。 &amp;emsp;&amp;emsp;zookeeper可以保证分布式一致性">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-07-25T14:00:00.000Z">
<meta property="article:modified_time" content="2021-08-02T13:53:11.291Z">
<meta property="article:author" content="WinKing">
<meta property="article:tag" content="zookeeper">
<meta property="article:tag" content="原理">
<meta property="article:tag" content="应用">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/blog/img/favicon.png"><link rel="canonical" href="http://cheng_qiwei.gitee.io/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/blog/WinKings%20Blogs" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-08-02 21:53:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/blog/img/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">25</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">48</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/blog/">WinKings Blogs</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">zookeeper详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-07-25T14:00:00.000Z" title="发表于 2021-07-25 22:00:00">2021-07-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-08-02T13:53:11.291Z" title="更新于 2021-08-02 21:53:11">2021-08-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/zookeeper/">zookeeper</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="zookeeper介绍"><a href="#zookeeper介绍" class="headerlink" title="zookeeper介绍"></a>zookeeper介绍</h1><h1 id="一、zookeeper简介"><a href="#一、zookeeper简介" class="headerlink" title="一、zookeeper简介"></a>一、zookeeper简介</h1><blockquote>
<p>官网：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/current/index.html">https://zookeeper.apache.org/doc/current/index.html</a></p>
</blockquote>
<h2 id="1、zookeeper是什么？"><a href="#1、zookeeper是什么？" class="headerlink" title="1、zookeeper是什么？"></a>1、zookeeper是什么？</h2><p>&emsp;&emsp;zookeeper是高性能的<font color='red'><strong>分布式协作服务和分布式数据一致性解决方案</strong></font>，由雅虎创建，是Goole Chubby的开源实现。</p>
<p>&emsp;&emsp;zookeeper可以保证分布式一致性特性，包括<strong>顺序一致性、原子性、统一视图、可靠性、实时性</strong>。</p>
<p>&emsp;&emsp;zookeeper的数据模型是一个树形节点，服务启动后，所有数据加载到内存中这样来提高服务器吞吐并减少延迟。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/zookeeper-01.jpg" alt="zookeeper"></p>
<h2 id="2、zookeeper的角色"><a href="#2、zookeeper的角色" class="headerlink" title="2、zookeeper的角色"></a>2、zookeeper的角色</h2><p>&emsp;&emsp;zookeeper中包含了领导者、跟随者、观察者等角色，具体各个角色的描述如下：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/image-20210723161303511.png" alt="image-20210723161303511"></p>
<h2 id="3、zookeeper的状态"><a href="#3、zookeeper的状态" class="headerlink" title="3、zookeeper的状态"></a>3、zookeeper的状态</h2><p>每个Server在工作过程中有三种状态：</p>
<table>
<thead>
<tr>
<th align="center">状态</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">LOOKING</td>
<td align="center">当前Server不知道leader是谁，正在搜寻</td>
</tr>
<tr>
<td align="center">LEADING</td>
<td align="center">当前Server即为选举出来的leader</td>
</tr>
<tr>
<td align="center">FOLLOWING</td>
<td align="center">leader已经选举出来，当前Server与之同步</td>
</tr>
</tbody></table>
<h2 id="4、zookeeper的数据模型"><a href="#4、zookeeper的数据模型" class="headerlink" title="4、zookeeper的数据模型"></a>4、zookeeper的数据模型</h2><p>&emsp;&emsp;zookeeper提供的命名空间与标准文件系统非常类似。名称是由斜线 （/）分开的路径元素序列。zookeeper名称空间中的每个节点都通过路径识别。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/image-20210723165034175.png" alt="image-20210723165034175"></p>
<p>　在每个结点上都存储了相应的数据，数据可以是字符串、二进制数。但是默认情况下每个结点的数据大小的<strong>上限是1M</strong>，这是因为Zookeeper主要是用来协调服务的，而不是存储数据，管理一些配置文件和应用列表之类的数据。虽然可以修改配置文件来改变数据大小的上限，但是为了服务的高效和稳定，建议结点数据不要超过默认值。　　　</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/735119-20161121140518690-1877317886.png"></p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/zookeeper%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png"></p>
<blockquote>
<ul>
<li>持久节点</li>
</ul>
<p>&emsp;&emsp;关于持久节点，他可以持久化应用数据，即使znode的创建者崩溃或断开连接，数据也不会丢失。</p>
<ul>
<li>临时节点</li>
</ul>
<p>&emsp;&emsp;关于临时节点，它的优势是应用于类似分布式锁的场景上，它无需要进行额外的处理，仅靠Session周期即可以完成。</p>
<ul>
<li>序列节点</li>
</ul>
<p>&emsp;&emsp;关于序列节点，多个线程创建同一个顺序节点时候，每个线程会得到一个带有编号的节点，节点编号是递增不重复的。</p>
</blockquote>
<h2 id="5、zookeeper的特征"><a href="#5、zookeeper的特征" class="headerlink" title="5、zookeeper的特征"></a>5、zookeeper的特征</h2><blockquote>
<p>顺序一致性：客户端的更新将按照发送顺序执行；</p>
<p>原子性：更新只有成功或失败，没有部分结果；</p>
<p>统一视图：无论服务器连接到哪个服务器，客户端都将看到相同的服务视图；</p>
<p>可靠性：一旦应用了更新，它将从那时起持续到客户端覆盖更新；</p>
<p>及时性：系统的客户视图保证在特定时间范围内是最新的。</p>
</blockquote>
<h1 id="二、zookeeper的使用"><a href="#二、zookeeper的使用" class="headerlink" title="二、zookeeper的使用"></a>二、zookeeper的使用</h1><h2 id="1、安装准备"><a href="#1、安装准备" class="headerlink" title="1、安装准备"></a>1、安装准备</h2><p>&emsp;&emsp;本次使用四台机器搭建zookeeper集群，分别如下：</p>
<table>
<thead>
<tr>
<th align="center">序号</th>
<th align="center">hostname:port</th>
<th align="center">角色</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">192.168.66.128</td>
<td align="center">master【leader】</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">192.168.66.129</td>
<td align="center">slave【follower】</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">192.168.66.130</td>
<td align="center">slave【follower】</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">192.168.66.131</td>
<td align="center">slave【observer】</td>
</tr>
</tbody></table>
<h3 id="问题：为什么zookeeper节点是奇数台？"><a href="#问题：为什么zookeeper节点是奇数台？" class="headerlink" title="问题：为什么zookeeper节点是奇数台？"></a>问题：为什么zookeeper节点是奇数台？</h3><blockquote>
<p>从<strong>容错率</strong>方面来讲：需要保证有半数进行投票，</p>
<p>&emsp;&emsp;对于2台服务器，至少2台正常运行才行，正常运行1台服务器都不允许挂掉，完全无容错，排除；</p>
<p>&emsp;&emsp;对于3台服务器，至少2台正常运行才行，正常运行可以允许1台服务器挂掉；</p>
<p>&emsp;&emsp;对于4台服务器，至少3台正常运行才行，正常运行可以允许1台服务器挂掉；</p>
<p>&emsp;&emsp;对于5台服务器，至少3台正常运行才行，正常运行可以允许2台服务器挂掉。</p>
<p>而从<strong>防止脑裂</strong>的方面来讲，</p>
<p>&emsp;&emsp;对于3台服务器，投票选举半数为1.5，一台服务裂开，和另外两台服务器无法通行，这时候2台服务器的集群（2票大于半数1.5票），所以可以选举出leader，而 1 台服务器的集群无法选举；</p>
<p>&emsp;&emsp;对于4台服务器，投票选举半数为2，可以分成 1,3两个集群或者2,2两个集群，对于 1,3集群，3集群可以选举；对于2,2集群，则不能选择，造成没有leader节点；</p>
<p>&emsp;&emsp;对于5台服务器，投票选举半数为2.5，可以分成1,4两个集群，或者2,3两集群，这两个集群分别都只能选举一个集群，满足zookeeper集群搭建数目。</p>
</blockquote>
<p>&emsp;&emsp;综上所述，我们从容错率以及防止脑裂两方面说明了3台服务器是搭建集群的最少数目，4台发生脑裂时会造成没有leader节点的错误，所以需要尽量避免偶数台zookeeper集群的搭建。</p>
<h2 id="2、下载zookeeper"><a href="#2、下载zookeeper" class="headerlink" title="2、下载zookeeper"></a>2、下载zookeeper</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载地址版本选择</span></span><br><span class="line">https://archive.apache.org/dist/zookeeper/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载目前的稳定版3.6.3</span></span><br><span class="line">wget https://archive.apache.org/dist/zookeeper/zookeeper-3.6.3/apache-zookeeper-3.6.3-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压安装包</span></span><br><span class="line">tar zxf apache-zookeeper-3.6.3-bin.tar.gz -C /usr/<span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<h2 id="3、配置zookeeper"><a href="#3、配置zookeeper" class="headerlink" title="3、配置zookeeper"></a>3、配置zookeeper</h2><p>&emsp;&emsp;修改配置文件<code>zoo.cfg</code>；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/apache-zookeeper-3.6.3-bin/conf/ &amp;&amp; cp zoo_sample.cfg zoo.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># The number of milliseconds of each tick</span></span><br><span class="line"><span class="comment"># Leader和Follow心跳 </span></span><br><span class="line">tickTime=2000</span><br><span class="line"></span><br><span class="line"><span class="comment"># The number of ticks that the initial</span></span><br><span class="line"><span class="comment"># synchronization phase can take</span></span><br><span class="line"><span class="comment"># 重试 主可以忍耐 一个follow的 2000 * 10 的一个延迟，超过则认为有问题</span></span><br><span class="line">initLimit=10</span><br><span class="line"></span><br><span class="line"><span class="comment"># The number of ticks that can pass between</span></span><br><span class="line"><span class="comment"># sending a request and getting an acknowledgement</span></span><br><span class="line"><span class="comment"># 同步 主和Follow 超过 2000 * 5 没有回馈，则认为有问题</span></span><br><span class="line">syncLimit=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># the directory where the snapshot is stored.</span></span><br><span class="line"><span class="comment"># do not use /tmp for storage, /tmp here is just</span></span><br><span class="line"><span class="comment"># example sakes.</span></span><br><span class="line"><span class="comment"># 数据持久化目录 需要将默认目录改成其他目录</span></span><br><span class="line">dataDir=/usr/<span class="built_in">local</span>/zookeeper/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># the port at which the clients will connect</span></span><br><span class="line"><span class="comment"># 客户端连接Zookeeper的端口号</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="comment"># the maximum number of client connections.</span></span><br><span class="line"><span class="comment"># increase this if you need to handle more clients</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最大客户端连接数</span></span><br><span class="line"><span class="comment">#maxClientCnxns=60</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Be sure to read the maintenance section of the</span></span><br><span class="line"><span class="comment"># administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The number of snapshots to retain in dataDir</span></span><br><span class="line"><span class="comment">#autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="comment"># Purge task interval in hours</span></span><br><span class="line"><span class="comment"># Set to &quot;0&quot; to disable auto purge feature</span></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#由于ZK没有像Redis那种发布订阅自动识别哨兵的集群，需要人为规划ZK集群</span></span><br><span class="line">server.1=192.168.163.128:2888:3888</span><br><span class="line">server.2=192.168.163.129:2888:3888</span><br><span class="line">server.3=192.168.163.130:2888:3888</span><br><span class="line">server.4=192.168.163.131:2888:3888</span><br><span class="line"></span><br><span class="line"><span class="comment">#server.X X满足过半通过3台时，最大的就是Leader</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这里最主要就是设置保存的data路径和集群节点信息。</p>
<h2 id="4、拷贝当前配置到其他主机"><a href="#4、拷贝当前配置到其他主机" class="headerlink" title="4、拷贝当前配置到其他主机"></a>4、拷贝当前配置到其他主机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改文件名</span></span><br><span class="line">mv apache-zookeeper-3.6.3-bin/ zookeeper-3.6.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝配置好的资源到其他机器   `pwd`是指和当前资源同一目录</span></span><br><span class="line">scp -r ./zookeeper-3.6.3/  ip:`<span class="built_in">pwd</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在每个节点创建数据目录</span></span><br><span class="line">mkdir -p /usr/<span class="built_in">local</span>/zookeeper/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置myid文件 值为 1 表示这是server.1, 其他机器同理 1~4</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /usr/<span class="built_in">local</span>/zookeeper/data/myid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置zookeeper_HOME,可以直接在任何目录下使用zk的相关命令</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="built_in">export</span> ZOOKEEPER_INSTALL=/usr/<span class="built_in">local</span>/zookeeper-3.6.3/</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$ZOOKEEPER_INSTALL</span>/bin</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<h2 id="5、启动zookeeper"><a href="#5、启动zookeeper" class="headerlink" title="5、启动zookeeper"></a>5、启动zookeeper</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启节点通信，否则启动会提示 没有到主机的路由</span></span><br><span class="line">firewall-cmd --zone=public --add-port=2181/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=2888/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=3888/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line">[root@localhost zookeeper]<span class="comment"># zkServer.sh help</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /home/<span class="built_in">local</span>/zookeeper/apache-zookeeper-3.5.8/bin/../conf/zoo.cfg</span><br><span class="line">Usage: /home/<span class="built_in">local</span>/zookeeper/apache-zookeeper-3.5.8/bin/zkServer.sh [--config &lt;conf-dir&gt;] &#123;start|start-foreground|stop|restart|status|print-cmd&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认不阻塞启动，当前使用阻塞启动看日志</span></span><br><span class="line">[root@localhost zookeeper]<span class="comment"># zkServer.sh start-foreground</span></span><br></pre></td></tr></table></figure>

<p>我们通过<code>zkServer.sh status</code>可以看到，当前Server.X最大的当选Leader，其他为Follower</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/image-20210728224659402.png" alt="image-20210728224659402"></p>
<h2 id="6、使用zookeeper"><a href="#6、使用zookeeper" class="headerlink" title="6、使用zookeeper"></a>6、使用zookeeper</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接zookeeper</span></span><br><span class="line">zkCli.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] <span class="built_in">help</span></span><br><span class="line">ZooKeeper -server host:port cmd args</span><br><span class="line">  addauth scheme auth</span><br><span class="line">  close </span><br><span class="line">  config [-c] [-w] [-s]</span><br><span class="line">  connect host:port</span><br><span class="line">  create [-s] [-e] [-c] [-t ttl] path [data] [acl]</span><br><span class="line">  delete [-v version] path</span><br><span class="line">  deleteall path</span><br><span class="line">  delquota [-n|-b] path</span><br><span class="line">  get [-s] [-w] path</span><br><span class="line">  getAcl [-s] path</span><br><span class="line">  <span class="built_in">history</span> </span><br><span class="line">  listquota path</span><br><span class="line">  ls [-s] [-w] [-R] path</span><br><span class="line">  ls2 path [watch]</span><br><span class="line">  printwatches on|off</span><br><span class="line">  quit </span><br><span class="line">  reconfig [-s] [-v version] [[-file path] | [-members serverID=host:port1:port2;port3[,...]*]] | [-add serverId=host:port1:port2;port3[,...]]* [-remove serverId[,...]*]</span><br><span class="line">  redo cmdno</span><br><span class="line">  removewatches path [-c|-d|-a] [-l]</span><br><span class="line">  rmr path</span><br><span class="line">  <span class="built_in">set</span> [-s] [-v version] path data</span><br><span class="line">  setAcl [-s] [-v version] [-R] path acl</span><br><span class="line">  setquota -n|-b val path</span><br><span class="line">  <span class="built_in">stat</span> [-w] path</span><br><span class="line">  sync path</span><br><span class="line">Command not found: Command not found <span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h2 id="7、测试相关命令"><a href="#7、测试相关命令" class="headerlink" title="7、测试相关命令"></a>7、测试相关命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看根目录</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] ls /</span><br><span class="line">[zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建节点 默认是持久节点</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] create /ooxx <span class="string">&quot;&quot;</span></span><br><span class="line">Created /ooxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#再次目录</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 4] ls /</span><br><span class="line">[ooxx, zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建节点里的节点</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 5] create /ooxx/xxoo <span class="string">&quot;&quot;</span></span><br><span class="line">Created /ooxx/xxoo</span><br><span class="line"></span><br><span class="line"><span class="comment">#再次节点里的目录</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 6] ls /ooxx</span><br><span class="line">[xxoo]</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置节点里的值</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] <span class="built_in">set</span> /ooxx <span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#获取节点里的值</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 8] get /ooxx</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看节点的状态</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 11] <span class="built_in">stat</span> /ooxx</span><br><span class="line"><span class="comment"># cZxid 有64位，前32位表示Leader的纪元，后32位表示事务ID</span></span><br><span class="line"><span class="comment"># ZK顺序执行，Leader维护着一个自增事务ID：00000002</span></span><br><span class="line"><span class="comment"># 0x2 表示的是Leader的纪元</span></span><br><span class="line"><span class="comment"># cZxid 的 c 表示 create，cZxid表示也就是创建节点的事务ID</span></span><br><span class="line">cZxid = 0x200000002</span><br><span class="line"><span class="comment"># 创建时间</span></span><br><span class="line">ctime = Fri Nov 27 22:19:42 CST 2020</span><br><span class="line"><span class="comment"># 修改节点的事务ID</span></span><br><span class="line">mZxid = 0x200000004</span><br><span class="line">mtime = Fri Nov 27 22:20:53 CST 2020</span><br><span class="line"><span class="comment"># 当前这个节点下创建的最后一个节点的ID,也就是 /ooxx/xxoo的cZxid</span></span><br><span class="line">pZxid = 0x200000003</span><br><span class="line">cversion = 1</span><br><span class="line">dataVersion = 1</span><br><span class="line">aclVersion = 0</span><br><span class="line"><span class="comment">#临时持有者 0x0表示持久节点，否则对应的是sessionId</span></span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 5</span><br><span class="line">numChildren = 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除节点</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] deleteall /ooxx</span><br></pre></td></tr></table></figure>

<p><strong>测试临时节点</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#断开客户端重新连接，能够看到日志输出了sesionid = 0x1000092017d0004</span></span><br><span class="line">2020-11-27 22:37:43,097 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn<span class="variable">$SendThread</span>@1394] - Session establishment complete on server localhost/0:0:0:0:0:0:0:1:2181, sessionid = 0x1000092017d0004, negotiated timeout = 30000</span><br><span class="line"></span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected <span class="built_in">type</span>:None path:null</span><br><span class="line"></span><br><span class="line"><span class="comment"># create [-s] [-e] [-c] [-t ttl] path [data] [acl]</span></span><br><span class="line"><span class="comment"># 创建一个临时节点</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] create -e /xoxo <span class="string">&quot;aaa&quot;</span></span><br><span class="line">Created /xoxo</span><br><span class="line"><span class="comment">#查看临时节点状态</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] <span class="built_in">stat</span> /xoxo</span><br><span class="line">cZxid = 0x20000000d</span><br><span class="line">ctime = Fri Nov 27 22:38:40 CST 2020</span><br><span class="line">mZxid = 0x20000000d</span><br><span class="line">mtime = Fri Nov 27 22:38:40 CST 2020</span><br><span class="line">pZxid = 0x20000000d</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line"><span class="comment">#临时节点归属于 0x1000092017d0004 的SessionId</span></span><br><span class="line">ephemeralOwner = 0x1000092017d0004</span><br><span class="line">dataLength = 3</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#这时候用另外一台机器连接zk，得到【sessionid = 0x400002966df0000】</span></span><br><span class="line"><span class="comment">#查看目录，能够查看到 xoxo</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[ooxx, xoxo, zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看临时节点状态</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] <span class="built_in">stat</span> /xoxo</span><br><span class="line">cZxid = 0x20000000d</span><br><span class="line">ctime = Fri Nov 27 22:38:40 CST 2020</span><br><span class="line">mZxid = 0x20000000d</span><br><span class="line">mtime = Fri Nov 27 22:38:40 CST 2020</span><br><span class="line">pZxid = 0x20000000d</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line"><span class="comment">#在其他节点中也能看到它的归属其他Session状态</span></span><br><span class="line">ephemeralOwner = 0x1000092017d0004</span><br><span class="line">dataLength = 3</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这时候将【sessionid = 0x1000092017d0004】的链接断开</span></span><br><span class="line"><span class="comment"># 然后在【sessionid = 0x400002966df0000】的链接中查看</span></span><br><span class="line"><span class="comment"># 已经查不到xoxo节点了，它随着session的断开而消失</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /</span><br><span class="line">[ooxx, zookeeper]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在临时节点里再新增节点会提示错误，因为临时节点无法加子节点</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 8] create /aaa/xxx</span><br><span class="line">Ephemerals cannot have children: /aaa/xxx</span><br></pre></td></tr></table></figure>

<p><strong>Zookeeper提供了统一视图的功能，它在客户端连接到Zookeeper创建Session时，会执行将Session添加到统一视图的事务，这时候事务ID + 1，当Session退出时，会执行一个将Session从统一视图删除的事务，事务ID +1。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#【sessionid = 0x400002966df0000】</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 4] create /xoxo <span class="string">&quot;&quot;</span></span><br><span class="line">Created /xoxo</span><br><span class="line">[zk: localhost:2181(CONNECTED) 5] <span class="built_in">stat</span> /xoxo</span><br><span class="line"><span class="comment">#认准当前事务ID是 00000010</span></span><br><span class="line">cZxid = 0x200000010</span><br><span class="line">ctime = Fri Nov 27 22:59:37 CST 2020</span><br><span class="line">mZxid = 0x200000010</span><br><span class="line">mtime = Fri Nov 27 22:59:37 CST 2020</span><br><span class="line">pZxid = 0x200000010</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#这时候创建一个客户端连接，创建了【sessionid = 0x400002966df0001】</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#回到【sessionid = 0x400002966df0000】</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 6] create /oxox <span class="string">&quot;bbb&quot;</span></span><br><span class="line">Created /oxox</span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] <span class="built_in">stat</span> /oxox</span><br><span class="line"><span class="comment"># 可以看到当前事务ID是 00000012</span></span><br><span class="line">cZxid = 0x200000012</span><br><span class="line">ctime = Fri Nov 27 23:04:14 CST 2020</span><br><span class="line">mZxid = 0x200000012</span><br><span class="line">mtime = Fri Nov 27 23:04:14 CST 2020</span><br><span class="line">pZxid = 0x200000012</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 3</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>问题：如果一个客户端连接了一个Zookeeper，这时候如果这台Zookeeper挂了，客户端的连接将转移到另外一台Zookeeper，这时候会重新创建Session吗？</p>
<p><strong>答：创建Session后，每个Zookeeper都能够从统一视图中获得这个Session会话，如果某个节点挂了，客户端转移另一台Zookeeper时，只要在Session超时的时间内重新连接了，就能保持原Session，默认超时时间是3秒。</strong></p>
</blockquote>
<h1 id="三、zookeeper的原理"><a href="#三、zookeeper的原理" class="headerlink" title="三、zookeeper的原理"></a>三、zookeeper的原理</h1><h2 id="1、Paxos"><a href="#1、Paxos" class="headerlink" title="1、Paxos"></a>1、Paxos</h2><blockquote>
<p>Paxos介绍：<a target="_blank" rel="noopener" href="https://www.douban.com/note/208430424/">https://www.douban.com/note/208430424/</a></p>
</blockquote>
<p>&emsp;&emsp;Paxos <strong>算法</strong>是莱斯利·兰伯特 1990 年提出的一种<strong>基于消息传递的、具有高容错性的一致性算法</strong>。</p>
<h3 id="1-1、Paxos与拜占庭将军问题"><a href="#1-1、Paxos与拜占庭将军问题" class="headerlink" title="1.1、Paxos与拜占庭将军问题"></a>1.1、Paxos与拜占庭将军问题</h3><p>&emsp;&emsp;拜占庭将军问题是由 Paxos 算法作者莱斯利·兰伯特提出的点对点通信中的基本问题。该问题要说明的含义是，<font color='red'>在不可靠信道上试图通过消息传递的方式达到一致性是不可能的</font>。所以，Paxos 算法的前提是<font color='red'>不存在拜占庭将军问题</font>，即信道是安全的、可靠的，集群节点间传 递的消息是不会被篡改的。</p>
<h3 id="1-2、Paxos的三种角色"><a href="#1-2、Paxos的三种角色" class="headerlink" title="1.2、Paxos的三种角色"></a>1.2、Paxos的三种角色</h3><p>&emsp;&emsp;在Paxos中具有三种角色，分别对应三种不同的行为。但在很多时候，一个进程可能同时充当着多种角色。</p>
<ul>
<li>Proposer：提案者，主要是提出提案（Proposal）；</li>
<li>Acceptor：表决者，主要是对提案者提出的提案进行投票表决；</li>
<li>Learner：学习者（同步者），主要是当提案（Proposal）决议形成，会获取保存形成的决议。</li>
</ul>
<h3 id="1-3、Paxos的算法一致性"><a href="#1-3、Paxos的算法一致性" class="headerlink" title="1.3、Paxos的算法一致性"></a>1.3、Paxos的算法一致性</h3><p>Paxos的算法一致性主要体现在以下几点：</p>
<ul>
<li>每提出提案时都会首先获取到一个具有全局唯一性的、递增的提案编号N，即在整个集群中是唯一的编号 N，然后将该编号赋予其要提出的提案；</li>
<li>每个表决者在表决某提案后，会将该提案的编号N记录在本地，这样每个表决者中保存的已经被表决的提案中会存在一个编号最大的提案，其编号假设为 maxN。每个表决者仅会表决编号大于自己本地 maxN 的提案；</li>
<li>在众多提案中最终只能有一个提案被选定；</li>
<li>一旦一个提案被选定，则其它服务器会主动同步该提案到本地；</li>
<li>没有提案被提出则不会有提案被选定。</li>
</ul>
<h3 id="1-4、Paxos算法流程"><a href="#1-4、Paxos算法流程" class="headerlink" title="1.4、Paxos算法流程"></a>1.4、Paxos算法流程</h3><p>&emsp;&emsp;Paxos 算法的执行过程划分为两个阶段：<strong>准备阶段 prepare</strong> 与<strong>接受阶段 accept</strong>。Ps:Learn阶段之前决议已经形成。</p>
<p><strong>阶段一：Prepare 阶段</strong></p>
<p>a、提案者准备提交一个编号为 N 的提案（该编号具有全局唯一性的、递增的），并向所有表决者发送 prepare(N)请求，用于试探集群是否支持该编号的提案；</p>
<p>b、每个表决者都保存着当前收到的提案编号的最大值 maxN ，每次收到新的提案时，会与记录的提案编号进行比较（需要满足算法一致性的第二点）：</p>
<blockquote>
<ol>
<li>当提案编号N &lt; maxN ，说明该提议已经过时，表决者应该不回应或拒绝该prepare(N)的请求；</li>
<li>当提案编号N &gt; maxN ，说明该提议可以接受，此时表决者会记录其为最新的 maxN，并将之前编号最大的提案返回给提案者 Proposal(myid,maxN,value)【表决者id，上一个最大提案编号，提案内容】，如果之前没有提案，则返回Proposal(myid,null,null)。</li>
</ol>
</blockquote>
<p><strong>阶段二：Accept 阶段</strong></p>
<p>a、当提案者发出 prepare(N)后，若收到了超过半数的表决者的反馈， 那么该提案者就会将其真正的提案 Proposal(myid,N,value)发送给所有的表决者；</p>
<p>b、当表决者接收到提案者发送的 Proposal(myid,N,value) 提案后，会再次拿出自己 曾经 accept 过的提案中的最大编号 maxN，或曾经记录下的 prepare 的最大编号，让 N 与它们进行比较，若 N <strong>大于等于</strong>这两个编号，则当前表决者 accept 该提案，并反馈给提案者。若 N 小于这两个编号，则表决者采取不回应或拒绝改提案；</p>
<p>c、若提案者没有接收到超过半数的表决者的 accept 反馈，则有两种可能的结果产生。一 是放弃该提案，不再提出；二是重新进入 prepare 阶段，递增提案编号，重新提出 prepare 请求。</p>
<p>d、若提案者接收到的反馈数量超过了半数，则其会向外广播两类信息：</p>
<blockquote>
<ol>
<li>向曾 accept 其提案的表决者发送“可执行数据同步信号”，即让它们执行其曾接收到的提案；</li>
<li>向未曾向其发送 accept 反馈的表决者发送“提案 + 可执行数据同步信号”，即让它们接受到该提案后马上执行。</li>
</ol>
</blockquote>
<h3 id="1-5、活锁问题"><a href="#1-5、活锁问题" class="headerlink" title="1.5、活锁问题"></a>1.5、活锁问题</h3><p>&emsp;&emsp;对于该算法，会出现活锁问题。那么什么是活锁问题呢？</p>
<blockquote>
<p>&emsp;&emsp;活锁指的是任务或者执行者没有被阻塞，由于某些条件没有满足，导致一直重复尝试—失败—尝试—失败的过程。处于活锁的实体是在不断的改变状态，活锁有可能自行解开。</p>
</blockquote>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/20180201150541570" alt="img"></p>
<p>&emsp;&emsp;通过选取主Proposer，就可以保证Paxos算法的活性。选择一个主Proposer，并规定只有主Proposer才能提出议案。这样一来，只要主Proposer和过半的Acceptor能够正常进行网络通信，那么肯定会有一个提案被批准（第二阶段的accept），则可以解决死循环导致的活锁问题。</p>
<h2 id="2、ZAB协议"><a href="#2、ZAB协议" class="headerlink" title="2、ZAB协议"></a>2、ZAB协议</h2><h3 id="2-1、什么是ZAB协议"><a href="#2-1、什么是ZAB协议" class="headerlink" title="2.1、什么是ZAB协议"></a>2.1、什么是ZAB协议</h3><p>&emsp;&emsp;ZAB（Zookeeper Atomic Broadcast） 协议是为分布式协调服务zookeeper专门设计的一种支持<strong>崩溃恢复的原子广播协议</strong>。在zookeeper中，主要依赖ZAB协议来实现分布式数据一致性，基于该协议，zookeeper实现了一种主备模式的系统架构来保持集群中各个副本之间的数据一致性。<strong>需要注意的是：ZAB借鉴Paxos算法，但又不像Paxos算法</strong>。</p>
<h3 id="2-2、ZAB协议核心"><a href="#2-2、ZAB协议核心" class="headerlink" title="2.2、ZAB协议核心"></a>2.2、ZAB协议核心</h3><p>&emsp;&emsp;Zab协议的核心：<strong>定义了事务请求的处理方式</strong>。</p>
<p>a、所有的事务请求必须由一个全局唯一的服务器来协调处理，这样的服务器被叫做 <strong>Leader服务器</strong>。其他剩余的服务器则是 <strong>Follower服务器</strong>。</p>
<p>b、Leader服务器负责将一个客户端事务请求，转换成一个 <strong>事务Proposal</strong>，并将该 Proposal 分发给集群中所有的 Follower 服务器，也就是向所有 Follower 节点发送数据广播请求。</p>
<p>c、分发之后Leader服务器需要等待Follower服务器的反馈（Ack请求），<strong>在Zab协议中，只要超过半数的Follower服务器进行了正确的反馈</strong>后（也就是收到半数以上的Follower的Ack请求），那么 Leader 就会再次向所有的 Follower服务器发送 Commit 消息，要求其将上一个 事务proposal 进行提交。</p>
<h3 id="2-3、ZAB协议阶段的划分"><a href="#2-3、ZAB协议阶段的划分" class="headerlink" title="2.3、ZAB协议阶段的划分"></a>2.3、ZAB协议阶段的划分</h3><p>ZAB协议整体可划分为两个基本的模式：<strong>消息广播 和 崩溃恢复；</strong></p>
<p>按协议原理可细分为四个阶段：<strong>选举（Leader Election）、发现（Discovery）、同步（Synchronization）和广播(Broadcast)</strong></p>
<p>按协议实现分为三个时期：<strong>选举（Fast Leader Election）、恢复(Recovery Phase)和广播(Broadcast Phase)</strong></p>
<h3 id="2-4、ZAB协议的内容"><a href="#2-4、ZAB协议的内容" class="headerlink" title="2.4、ZAB协议的内容"></a>2.4、ZAB协议的内容</h3><p>&emsp;&emsp;Zab 协议包括两种基本的模式：<strong>崩溃恢复</strong> 和 <strong>消息广播</strong></p>
<p>协议过程：</p>
<p>&emsp;&emsp;当整个集群启动过程中，或者当 Leader 服务器出现网络中弄断、崩溃退出或重启等异常时，Zab协议就会 <strong>进入崩溃恢复模式</strong>，选举产生新的Leader。</p>
<p>&emsp;&emsp;当选举产生了新的 Leader，同时集群中有过半的机器与该 Leader 服务器完成了状态同步（即数据同步）之后，Zab协议就会退出崩溃恢复模式，<strong>进入消息广播模式</strong>。</p>
<p>&emsp;&emsp;这时，如果有一台遵守Zab协议的服务器加入集群，因为此时集群中已经存在一个Leader服务器在广播消息，那么该新加入的服务器自动进入恢复模式：找到Leader服务器，并且完成数据同步。同步完成后，作为新的Follower一起参与到消息广播流程中。</p>
<p>协议状态切换：</p>
<p>&emsp;&emsp;当Leader出现崩溃退出或者机器重启，亦或是集群中不存在超过半数的服务器与Leader保存正常通信，Zab就会再一次进入崩溃恢复，发起新一轮Leader选举并实现数据同步。同步完成后又会进入消息广播模式，接收事务请求。</p>
<p>保证消息有序：</p>
<p>&emsp;&emsp;在整个消息广播中，Leader会将每一个事务请求转换成对应的 proposal 来进行广播，并且在广播 事务Proposal 之前，Leader服务器会首先为这个事务Proposal分配一个全局单递增的唯一ID，称之为事务ID（即zxid），由于Zab协议需要保证每一个消息的严格的顺序关系，因此必须将每一个proposal按照其zxid的先后顺序进行排序和处理。</p>
<h4 id="2-4-1、消息广播"><a href="#2-4-1、消息广播" class="headerlink" title="2.4.1、消息广播"></a>2.4.1、消息广播</h4><p>消息广播实际上是一个队列+简化版的2PC提交过程。</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/zookeeper%E6%B6%88%E6%81%AF%E5%B9%BF%E6%92%AD.png"></p>
<blockquote>
<p>消息广播流程，如上图：</p>
<ol>
<li>客户端发起一个写操作请求 Create，由Follower转发给Leader；</li>
<li>Leader 服务器将客户端的请求转化为事务 Proposal 提案，同时为每个 Proposal 分配一个全局的ID，即Zxid；</li>
<li>Leader 服务器为每个 Follower 服务器分配一个单独的队列，然后将需要广播的 Proposal 依次放到队列中取，并且根据 FIFO 策略进行消息发送；</li>
<li>Follower 接收到 Proposal 后，会首先将其以事务日志的方式写入本地磁盘中，写入成功后向 Leader 反馈一个 Ack 响应消息；</li>
<li>Leader 接收到超过半数以上 Follower 的 Ack 响应消息后，即认为消息发送成功，可以发送 commit 消息；</li>
<li>Leader 向所有 Follower 广播 commit 消息，同时自身也会完成事务提交。Follower 接收到 commit 消息后，会将上一条事务提交。</li>
</ol>
</blockquote>
<p>&emsp;&emsp;<strong>Leader 服务器与每一个 Follower 服务器之间都维护了一个单独的 FIFO 消息队列进行收发消息，使用队列消息可以做到异步解耦。 Leader 和 Follower 之间只需要往队列中发消息即可。如果使用同步的方式会引起阻塞，性能要下降很多。</strong></p>
<h4 id="2-4-2、崩溃恢复"><a href="#2-4-2、崩溃恢复" class="headerlink" title="2.4.2、崩溃恢复"></a>2.4.2、崩溃恢复</h4><p>&emsp;&emsp;<strong>一旦 Leader 服务器出现崩溃或者由于网络原因导致 Leader 服务器失去了与过半 Follower 的联系，那么就会进入崩溃恢复模式。</strong></p>
<p>&emsp;&emsp;在 Zab 协议中，为了保证程序的正确运行，整个恢复过程结束后需要选举出一个新的 Leader 服务器。因此 Zab 协议需要一个高效且可靠的 Leader 选举算法，从而确保能够快速选举出新的 Leader 。同时，Leader 选举算法不仅仅需要让 Leader 自己知道自己已经被选举为 Leader ，同时还需要让集群中的所有其他机器也能够快速感知到选举产生的新 Leader 服务器。</p>
<p>&emsp;&emsp;Zab协议中，崩溃恢复主要包括两部分：<strong>Leader选举</strong> 和 <strong>数据恢复</strong>。</p>
<h5 id="2-4-2-1、Leader选举"><a href="#2-4-2-1、Leader选举" class="headerlink" title="2.4.2.1、Leader选举"></a>2.4.2.1、Leader选举</h5><p>&emsp;&emsp;在这个阶段，要符合成为新的Leader条件是需要是之前<strong>数据最全的节点</strong>（Zxid最大）才可以成为新的Leader，而在此以外，如果所有节点正常同步数据，则会根据其myid来选举成为Leader，下面我们举个例子：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/zookeeper%E9%80%89%E4%B8%BE.png"></p>
<blockquote>
<p>选举流程：</p>
<p>我们先看步骤一：有四个节点，此时，node4为Leader，此时触发了过半通过，而node3尚未同步最新的数据（Zxid07 -&gt; Zxid08），但此时却出现node4挂了，假设此时node3先识别出Leader挂了，触发选举机制；</p>
<p>来到步骤二：node3推选自己作为Leader，先给自己投了一票，然后将自己的信息推送给其它node；</p>
<p>接着到步骤三：其它node获得node3的推送后一对比，比自己的信息旧，驳回node3的信息，并将自己的信息推送出去，同时给自己投了一票；</p>
<p>到了步骤四：node3收到node1和node2的信息，发现他们信息都比自己全，此时就会向他们投票；同时node1和node2也收到对方发过来的信息，node1发现自己和node2的信息量一致，同时node2的myid比自己大，所以向node2投了一票，而node2和node1一样，但由于其myid比自己小，所以没有向其投票。所以此时node2拥有最多3票，统计之后成为新的Leader；</p>
<p>最后到步骤五，新的Leader选举出来后，就开始进入数据恢复阶段。</p>
</blockquote>
<h5 id="2-4-2-2、数据恢复"><a href="#2-4-2-2、数据恢复" class="headerlink" title="2.4.2.2、数据恢复"></a>2.4.2.2、数据恢复</h5><p>&emsp;&emsp;选举完成后，Followers 和上一轮选举出的准 Leader 进行通信，同步 Followers 最近接收的事务 Proposal 。一个 Follower 只会连接一个 Leader，如果一个 Follower 节点认为另一个 Follower 节点，则会在尝试连接时被拒绝。被拒绝之后，该节点就会进入 Leader Election阶段。<strong>Follower 只会接收 zxid 比自己 lastZxid 大的 Proposal。只有当 quorum（超过半数的节点） 都同步完成，准 Leader 才会成为真正的 Leader。</strong>接着，系统就会重新回到消息广播模式。</p>
<h1 id="四、zookeeper的应用"><a href="#四、zookeeper的应用" class="headerlink" title="四、zookeeper的应用"></a>四、zookeeper的应用</h1><h2 id="通用配置"><a href="#通用配置" class="headerlink" title="通用配置"></a>通用配置</h2><p><strong>引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="comment">&lt;!--根据zookeeper版本调整--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ZookeeperUtil</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.cheng.zookeeper.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: zookeeper配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cheng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/7/30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperUtil</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ZooKeeper zooKeeper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String url = <span class="string">&quot;192.168.2.61:2181/config&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DefaultWatch defaultWatch = <span class="keyword">new</span> DefaultWatch();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZooKeeper <span class="title">getZooKeeper</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            defaultWatch.setCountDownLatch(countDownLatch);</span><br><span class="line">            zooKeeper = <span class="keyword">new</span> ZooKeeper(url, <span class="number">3000</span>, defaultWatch);</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> zooKeeper;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZooKeeper <span class="title">getZooKeeper</span><span class="params">(String url)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            defaultWatch.setCountDownLatch(countDownLatch);</span><br><span class="line">            zooKeeper = <span class="keyword">new</span> ZooKeeper(url, <span class="number">3000</span>, defaultWatch);</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> zooKeeper;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DefaultWatch</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.cheng.zookeeper.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultWatch</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch countDownLatch;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CountDownLatch <span class="title">getCountDownLatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> countDownLatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCountDownLatch</span><span class="params">(CountDownLatch countDownLatch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.countDownLatch = countDownLatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DefaultWatch：&quot;</span>+watchedEvent.toString());</span><br><span class="line">        <span class="keyword">switch</span> (watchedEvent.getState()) &#123;</span><br><span class="line">            <span class="keyword">case</span> Disconnected:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SyncConnected:</span><br><span class="line">                System.out.println(<span class="string">&quot;连接成功！......&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AuthFailed:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ConnectedReadOnly:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SaslAuthenticated:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Expired:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Closed:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1、作为配置中心"><a href="#1、作为配置中心" class="headerlink" title="1、作为配置中心"></a>1、作为配置中心</h2><h3 id="1-1、核心类"><a href="#1-1、核心类" class="headerlink" title="1.1、核心类"></a>1.1、核心类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.cheng.zookeeper.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.cheng.zookeeper.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.AsyncCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: zookeeper作为配置中心的核心代码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cheng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/7/30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationWatchCallBack</span> <span class="keyword">implements</span> <span class="title">Watcher</span> , <span class="title">AsyncCallback</span>.<span class="title">StatCallback</span> , <span class="title">AsyncCallback</span>.<span class="title">DataCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zooKeeper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ZooKeeper <span class="title">getZooKeeper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> zooKeeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setZooKeeper</span><span class="params">(ZooKeeper zooKeeper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zooKeeper = zooKeeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//阻塞等待获取数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span></span>&#123;</span><br><span class="line">        zooKeeper.exists(<span class="string">&quot;/username&quot;</span>,<span class="keyword">this</span>,<span class="keyword">this</span>,<span class="string">&quot;exits&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//根据不同的Watch的类型进行不同的动作</span></span><br><span class="line">        <span class="keyword">switch</span> (watchedEvent.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> None:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NodeCreated:</span><br><span class="line">                <span class="comment">//如果事件检测到节点创建，则获取数据，释放闭锁阻塞</span></span><br><span class="line">                zooKeeper.getData(<span class="string">&quot;/username&quot;</span>,<span class="keyword">this</span>,<span class="keyword">this</span>,<span class="string">&quot;getData&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NodeDeleted:</span><br><span class="line">                <span class="comment">//如果检测到节点被删除了，就需要删除数据，重新进入等待状态</span></span><br><span class="line">                user.setUsername(<span class="keyword">null</span>);</span><br><span class="line">                countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NodeDataChanged:</span><br><span class="line">                <span class="comment">//数据发生改变，需要重新获取数据</span></span><br><span class="line">                zooKeeper.getData(<span class="string">&quot;/username&quot;</span>,<span class="keyword">this</span>,<span class="keyword">this</span>,<span class="string">&quot;getData&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NodeChildrenChanged:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DataWatchRemoved:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ChildWatchRemoved:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PersistentWatchRemoved:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//exits的回调</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> i, String s, Object o, Stat stat)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果判断存在，则可以获取数据</span></span><br><span class="line">        zooKeeper.getData(<span class="string">&quot;/username&quot;</span>,<span class="keyword">this</span>,<span class="keyword">this</span>,<span class="string">&quot;getData&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getData的回调</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> i, String s, Object o, <span class="keyword">byte</span>[] data, Stat stat)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获得数据后，就需要打印数据，并停止等待（释放等待的方法）</span></span><br><span class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String result = <span class="keyword">new</span> String(data);</span><br><span class="line">            user.setUsername(result);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2、测试类"><a href="#1-2、测试类" class="headerlink" title="1.2、测试类"></a>1.2、测试类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.cheng.zookeeper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.cheng.zookeeper.config.ConfigurationWatchCallBack;</span><br><span class="line"><span class="keyword">import</span> cn.cheng.zookeeper.config.ZookeeperUtil;</span><br><span class="line"><span class="keyword">import</span> cn.cheng.zookeeper.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.AsyncCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.data.Stat;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.BeforeEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: zookeeper作为配置中心测试代码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cheng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/7/30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZookeeperConfigurationCenterTests</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ZooKeeper zooKeeper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">        zooKeeper = ZookeeperUtil.getZooKeeper();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zooKeeper.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        ConfigurationWatchCallBack watchCallBack = <span class="keyword">new</span> ConfigurationWatchCallBack();</span><br><span class="line">        watchCallBack.setZooKeeper(zooKeeper);</span><br><span class="line">        watchCallBack.setUser(user);</span><br><span class="line"></span><br><span class="line">        watchCallBack.await();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(user.getUsername() != <span class="keyword">null</span> &amp;&amp; user.getUsername() != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;用戶名為：&quot;</span> + user.getUsername());</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//配置被删了</span></span><br><span class="line">                System.out.println(<span class="string">&quot;配置已被删除......&quot;</span>);</span><br><span class="line">                watchCallBack.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、作为分布式锁"><a href="#2、作为分布式锁" class="headerlink" title="2、作为分布式锁"></a>2、作为分布式锁</h2><h3 id="2-1、核心类"><a href="#2-1、核心类" class="headerlink" title="2.1、核心类"></a>2.1、核心类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.cheng.zookeeper.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 分布式锁</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cheng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/7/30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockWatchCallBack</span> <span class="keyword">implements</span> <span class="title">Watcher</span>, <span class="title">AsyncCallback</span>.<span class="title">StringCallback</span>, <span class="title">AsyncCallback</span>.<span class="title">Children2Callback</span>,<span class="title">AsyncCallback</span>.<span class="title">StatCallback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zooKeeper;</span><br><span class="line">    <span class="keyword">private</span> String threadName;</span><br><span class="line">    <span class="keyword">private</span> String lockName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ZooKeeper <span class="title">getZooKeeper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> zooKeeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setZooKeeper</span><span class="params">(ZooKeeper zooKeeper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zooKeeper = zooKeeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getThreadName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> threadName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThreadName</span><span class="params">(String threadName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.threadName = threadName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;加锁 ------&gt; &quot;</span> + threadName);</span><br><span class="line">            <span class="comment">//TODO 此处可增加节点内容数据判断，实现可重入操作</span></span><br><span class="line">            <span class="comment">//当前线程创建临时序列节点</span></span><br><span class="line">            zooKeeper.create(<span class="string">&quot;/lock&quot;</span>, threadName.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">                    CreateMode.EPHEMERAL_SEQUENTIAL, <span class="keyword">this</span>, threadName);</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;解锁 ------&gt; &quot;</span> + threadName);</span><br><span class="line">            zooKeeper.delete(lockName, -<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getData</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] data = zooKeeper.getData(<span class="string">&quot;/&quot;</span>, <span class="keyword">false</span>, <span class="keyword">new</span> Stat());</span><br><span class="line">        System.out.println(threadName + <span class="string">&quot; 获取当前数据：&quot;</span> + <span class="keyword">new</span> String(data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//观察自己的子节点是否删除了，删除可以重新获取锁</span></span><br><span class="line">        Event.EventType type = watchedEvent.getType();</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> NodeDeleted:</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 这里的作用有两个</span></span><br><span class="line"><span class="comment">                 * 如果是前一个节点被删除（解锁），获取父节点下的所有子节点 =&gt; Children2Callback中重新判断当前节点是否为第一个节点</span></span><br><span class="line"><span class="comment">                 * 如果是第一个节点挂了，当前节点也能收到回调，获取父节点下的所有子节点，重新监控当前节点前面新的节点</span></span><br><span class="line"><span class="comment">                 * */</span></span><br><span class="line">                zooKeeper.getChildren(<span class="string">&quot;/&quot;</span>, <span class="keyword">false</span>, <span class="keyword">this</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NodeChildrenChanged:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建锁的回调</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> i, String s, Object o, String pathName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(pathName))&#123;</span><br><span class="line">            System.out.println(threadName + <span class="string">&quot;  创建了节点: &quot;</span> + pathName);</span><br><span class="line">            <span class="comment">//每个线程启动后创建锁，然后get锁目录的所有孩子，不需要监控当前根节点，所以watch设置为false</span></span><br><span class="line">            lockName = pathName;</span><br><span class="line">            zooKeeper.getChildren(<span class="string">&quot;/&quot;</span>, <span class="keyword">false</span>, <span class="keyword">this</span>, o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建获取孩子的回调</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> i, String s, Object o, List&lt;String&gt; children, Stat stat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Collections.sort(children);</span><br><span class="line">            <span class="keyword">int</span> num = children.indexOf(lockName.substring(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//说明当前自己是第一位，获得执行的资格，执行完之后，释放锁</span></span><br><span class="line">                System.out.println(threadName + <span class="string">&quot;获得当前的第一位，可以执行了！&quot;</span>);</span><br><span class="line">                zooKeeper.setData(<span class="string">&quot;/&quot;</span>, threadName.getBytes(), -<span class="number">1</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//说明当前自己不是第一位，不能执行，此时就需要监控自己的上一位执行了（退出了）吗（是不是从该节点消失）,是的话就可以重新获取锁</span></span><br><span class="line">                System.out.println(threadName+<span class="string">&quot; 观察上一位 &quot;</span>+children.get(num-<span class="number">1</span>));</span><br><span class="line">                zooKeeper.exists(<span class="string">&quot;/&quot;</span> + children.get(num - <span class="number">1</span>), <span class="keyword">this</span>,<span class="keyword">this</span>,<span class="string">&quot;ctx&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> i, String s, Object o, Stat stat)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//TODO 判断是否存在的节点状态回调</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2、测试类"><a href="#2-2、测试类" class="headerlink" title="2.2、测试类"></a>2.2、测试类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.cheng.zookeeper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.cheng.zookeeper.config.ConfigurationWatchCallBack;</span><br><span class="line"><span class="keyword">import</span> cn.cheng.zookeeper.config.LockWatchCallBack;</span><br><span class="line"><span class="keyword">import</span> cn.cheng.zookeeper.config.ZookeeperUtil;</span><br><span class="line"><span class="keyword">import</span> cn.cheng.zookeeper.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.BeforeEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: zookeeper作为分布式锁测试代码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cheng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/7/30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZookeeperLockTests</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String url = <span class="string">&quot;192.168.2.61:2181/lockBox&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ZooKeeper zooKeeper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">        zooKeeper = ZookeeperUtil.getZooKeeper(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zooKeeper.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                LockWatchCallBack lock = <span class="keyword">new</span> LockWatchCallBack();</span><br><span class="line">                lock.setZooKeeper(zooKeeper);</span><br><span class="line">                lock.setThreadName(Thread.currentThread().getName());</span><br><span class="line">                <span class="comment">//加锁-干活(休眠1s+获取当前锁信息+打印数据)-解锁</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.tryLock();</span><br><span class="line">                   <span class="comment">//这里如果不睡眠的话，可能第一个节点已经删除，第二个节点还没监控到，等第二个节点开启监控时，第一个节点已经没了</span></span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    lock.getData();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;：工作中......&quot;</span>);</span><br><span class="line">                    lock.unLock();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="string">&quot;Thread-&quot;</span>+i).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下图：</p>
<p><img src="http://cheng_qiwei.gitee.io/blog/img/image-20210802115334936.png" alt="image-20210802115334936"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">WinKing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://cheng_qiwei.gitee.io/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/">http://cheng_qiwei.gitee.io/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cheng_qiwei.gitee.io/blog" target="_blank">WinKings Blogs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/zookeeper/">zookeeper</a><a class="post-meta__tags" href="/blog/tags/%E5%8E%9F%E7%90%86/">原理</a><a class="post-meta__tags" href="/blog/tags/%E5%BA%94%E7%94%A8/">应用</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=null" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/blog/2021/07/10/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E5%88%86%E5%8C%BA%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94Hash%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7Hash/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">分布式缓存分区算法——Hash与一致性Hash</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/blog/2021/03/15/Linux安装软件/" title="Linux安装软件"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-15</div><div class="title">Linux安装软件</div></div></a></div><div><a href="/blog/2021/04/22/ElasticSearch高级篇/" title="ElasticSearch高级篇"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-22</div><div class="title">ElasticSearch高级篇</div></div></a></div><div><a href="/blog/2021/05/10/MySQL原理与优化/" title="MySQL原理与优化"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">MySQL原理与优化</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/blog/img/touxiang.jpg" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">WinKing</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">25</div></a></div><div class="card-info-data-item is-center"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">48</div></a></div><div class="card-info-data-item is-center"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/cheng_qiwei"><i class="fab fa-gitee"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#zookeeper%E4%BB%8B%E7%BB%8D"><span class="toc-text">zookeeper介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81zookeeper%E7%AE%80%E4%BB%8B"><span class="toc-text">一、zookeeper简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81zookeeper%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">1、zookeeper是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81zookeeper%E7%9A%84%E8%A7%92%E8%89%B2"><span class="toc-text">2、zookeeper的角色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81zookeeper%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-text">3、zookeeper的状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81zookeeper%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">4、zookeeper的数据模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81zookeeper%E7%9A%84%E7%89%B9%E5%BE%81"><span class="toc-text">5、zookeeper的特征</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81zookeeper%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">二、zookeeper的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87"><span class="toc-text">1、安装准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88zookeeper%E8%8A%82%E7%82%B9%E6%98%AF%E5%A5%87%E6%95%B0%E5%8F%B0%EF%BC%9F"><span class="toc-text">问题：为什么zookeeper节点是奇数台？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%B8%8B%E8%BD%BDzookeeper"><span class="toc-text">2、下载zookeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E9%85%8D%E7%BD%AEzookeeper"><span class="toc-text">3、配置zookeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%8B%B7%E8%B4%9D%E5%BD%93%E5%89%8D%E9%85%8D%E7%BD%AE%E5%88%B0%E5%85%B6%E4%BB%96%E4%B8%BB%E6%9C%BA"><span class="toc-text">4、拷贝当前配置到其他主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E5%90%AF%E5%8A%A8zookeeper"><span class="toc-text">5、启动zookeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E4%BD%BF%E7%94%A8zookeeper"><span class="toc-text">6、使用zookeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-text">7、测试相关命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81zookeeper%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-text">三、zookeeper的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81Paxos"><span class="toc-text">1、Paxos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81Paxos%E4%B8%8E%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98"><span class="toc-text">1.1、Paxos与拜占庭将军问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81Paxos%E7%9A%84%E4%B8%89%E7%A7%8D%E8%A7%92%E8%89%B2"><span class="toc-text">1.2、Paxos的三种角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81Paxos%E7%9A%84%E7%AE%97%E6%B3%95%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">1.3、Paxos的算法一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81Paxos%E7%AE%97%E6%B3%95%E6%B5%81%E7%A8%8B"><span class="toc-text">1.4、Paxos算法流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%E3%80%81%E6%B4%BB%E9%94%81%E9%97%AE%E9%A2%98"><span class="toc-text">1.5、活锁问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81ZAB%E5%8D%8F%E8%AE%AE"><span class="toc-text">2、ZAB协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFZAB%E5%8D%8F%E8%AE%AE"><span class="toc-text">2.1、什么是ZAB协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81ZAB%E5%8D%8F%E8%AE%AE%E6%A0%B8%E5%BF%83"><span class="toc-text">2.2、ZAB协议核心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81ZAB%E5%8D%8F%E8%AE%AE%E9%98%B6%E6%AE%B5%E7%9A%84%E5%88%92%E5%88%86"><span class="toc-text">2.3、ZAB协议阶段的划分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81ZAB%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-text">2.4、ZAB协议的内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1%E3%80%81%E6%B6%88%E6%81%AF%E5%B9%BF%E6%92%AD"><span class="toc-text">2.4.1、消息广播</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2%E3%80%81%E5%B4%A9%E6%BA%83%E6%81%A2%E5%A4%8D"><span class="toc-text">2.4.2、崩溃恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-1%E3%80%81Leader%E9%80%89%E4%B8%BE"><span class="toc-text">2.4.2.1、Leader选举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-2%E3%80%81%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="toc-text">2.4.2.2、数据恢复</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81zookeeper%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-text">四、zookeeper的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">通用配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-text">1、作为配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E6%A0%B8%E5%BF%83%E7%B1%BB"><span class="toc-text">1.1、核心类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-text">1.2、测试类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%BD%9C%E4%B8%BA%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">2、作为分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E6%A0%B8%E5%BF%83%E7%B1%BB"><span class="toc-text">2.1、核心类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-text">2.2、测试类</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/" title="zookeeper详解"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="zookeeper详解"/></a><div class="content"><a class="title" href="/blog/2021/07/25/zookeeper%E4%BB%8B%E7%BB%8D/" title="zookeeper详解">zookeeper详解</a><time datetime="2021-07-25T14:00:00.000Z" title="发表于 2021-07-25 22:00:00">2021-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/07/10/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E5%88%86%E5%8C%BA%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94Hash%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7Hash/" title="分布式缓存分区算法——Hash与一致性Hash"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="分布式缓存分区算法——Hash与一致性Hash"/></a><div class="content"><a class="title" href="/blog/2021/07/10/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E5%88%86%E5%8C%BA%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94Hash%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7Hash/" title="分布式缓存分区算法——Hash与一致性Hash">分布式缓存分区算法——Hash与一致性Hash</a><time datetime="2021-07-10T14:00:00.000Z" title="发表于 2021-07-10 22:00:00">2021-07-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/30/Redis%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%8C%BA/" title="Redis集群与分区"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis集群与分区"/></a><div class="content"><a class="title" href="/blog/2021/06/30/Redis%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%8C%BA/" title="Redis集群与分区">Redis集群与分区</a><time datetime="2021-06-30T14:00:00.000Z" title="发表于 2021-06-30 22:00:00">2021-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/14/Redis%E7%9A%84%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" title="Redis的进阶使用"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis的进阶使用"/></a><div class="content"><a class="title" href="/blog/2021/06/14/Redis%E7%9A%84%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" title="Redis的进阶使用">Redis的进阶使用</a><time datetime="2021-06-14T14:00:00.000Z" title="发表于 2021-06-14 22:00:00">2021-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/07/Redis%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%91%BD%E4%BB%A4/" title="Redis介绍与命令"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Redis介绍与命令"/></a><div class="content"><a class="title" href="/blog/2021/06/07/Redis%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%91%BD%E4%BB%A4/" title="Redis介绍与命令">Redis介绍与命令</a><time datetime="2021-06-07T14:00:00.000Z" title="发表于 2021-06-07 22:00:00">2021-06-07</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By WinKing</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="/blog/js/tw_cn.js"></script><script src="/blog/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script></div></body></html>